<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POS â€“ Ruta de Venta</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --ok:#1e8e3e; --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9); --muted:rgba(0,0,0,.55); --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Arial; color:#111; background:var(--bg-grad);
      display:flex; flex-direction:column; -webkit-font-smoothing:antialiased; -webkit-tap-highlight-color:transparent;
    }

header{
  position:sticky; top:0; z-index:50;
  background:rgba(0,0,0,.6);
  color:#fff;
  padding:10px 14px;
  display:flex; justify-content:center; align-items:center; gap:8px;
  font-weight:700; font-size:18px;
  backdrop-filter:saturate(120%) blur(4px);
  height:45px;       /* ðŸ‘ˆ altura fija */
}
header img{
  height:55px;       /* ðŸ‘ˆ ajusta el logo sin crecer el fondo */
  object-fit:contain;
}

    .wrap{flex:1; padding:12px; display:flex; flex-direction:column; gap:12px; max-width:720px; margin:0 auto}

    .controls{ display:flex; flex-direction:column; gap:10px; }
    .field{
      display:flex; gap:8px; background:rgba(255,255,255,.12); padding:10px; border-radius:var(--radius-sm);
      align-items:center; backdrop-filter:blur(2px);
    }
    .field label{min-width:78px; color:#fff; font-size:13px}
    .field input{ flex:1; padding:10px 12px; border:none; border-radius:8px; font-size:15px; background:#fff; outline:none; }

    /* Buscador */
    .searchbox{ position:relative; z-index:300; }
    .search-results{
      position:absolute; left:90px; right:10px; top:calc(100% + 6px);
      background:#fff; border-radius:12px; box-shadow:var(--shadow);
      max-height:260px; overflow:auto; display:none; z-index:310;
    }
    .result-item{ padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px }
    .result-item small{ color:var(--muted) }
    .result-item:hover{ background:#f2f4f7 }

    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }

    /* Tabla */
    .table-wrap{ max-height:260px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    thead th{ background:var(--azul); color:#fff; padding:10px; font-size:13px; position:sticky; top:0; z-index:100; }
    thead th:nth-child(1){ width:55%; text-align:left; }
    thead th:nth-child(2){ width:15%; text-align:center; }
    thead th:nth-child(3){ width:20%; text-align:right; }
    thead th:nth-child(4){ width:10%; text-align:center; }
    td.del-col{ text-align:center; }
    td.del-col .del{
      background:#e74c3c;
      color:#fff;
      border:none;
      border-radius:50%;
      width:22px;
      height:22px;
      font-size:14px;
      line-height:20px;
      cursor:pointer;
    }
    td.del-col .del:hover{ background:#c0392b; }

    .qty{ display:inline-flex; align-items:center; gap:8px; background:#f6f8fb; border-radius:999px; padding:4px 8px; }
    .qty button{
      width:26px; height:26px; border:none; border-radius:999px; cursor:pointer; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.12);
      font-size:16px; line-height:26px;
    }

    .totals{ display:flex; flex-direction:column; gap:6px; padding:12px 14px; background:#fff; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:15px }
    .row.muted{ color:var(--muted) }
    .row.big{ font-weight:700; font-size:18px }

    .actions{ padding:6px 0 12px }
    .btn{
      width:100%; border:none; padding:14px; border-radius:12px; font-size:18px; font-weight:700; color:#fff;
      background:linear-gradient(180deg,var(--resalte),#094d85); box-shadow:var(--shadow); cursor:pointer;
    }
    .btn:active{ transform:translateY(1px) }
    #btnCorte{ background:linear-gradient(180deg,#1e8e3e,#146329); margin-top:10px; }

    /* Modal Cobro */
    #modalCobro{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1200; align-items:center; justify-content:center; }
    .modal-card{ width:min(520px,92vw); background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden; }
    .modal-h{ padding:12px 16px; background:#0c6cbd; color:#fff; font-weight:700; }
    .modal-b{ padding:14px 16px; display:flex; flex-direction:column; gap:10px; }
    .modal-b input,.modal-b select{ padding:10px; border-radius:10px; border:1px solid #e1e5ea; }
    body.modal-open{ overflow:hidden; }

    /* ===== IMPRESIÃ“N DEL TICKET ===== */
    #ticketArea{ display:none; }
    @media print{
      :root{ --ticket-mm:72; --ticket-pad-mm:1; --ticket-font:18px; --line-height:1.08; }
      @page{ size: calc(var(--ticket-mm) * 1mm) auto; margin:0; }
      html,body{ background:#fff!important; height:auto!important; width:calc(var(--ticket-mm) * 1mm); margin:0!important; padding:0!important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      body *{ visibility:hidden!important; }
      #ticketArea, #ticketArea *{ visibility:visible!important; }
      #ticketArea{ position:fixed; inset:0; display:block!important; background:#fff!important; padding:0; margin:0; z-index:99999; }
      #tTipoRow{ display:none !important; }
      .ticket{ width:calc(var(--ticket-mm) * 1mm); margin:0 auto; padding:0 calc(var(--ticket-pad-mm) * 1mm); box-sizing:border-box; font:var(--ticket-font)/var(--line-height) 'Poppins',system-ui,sans-serif; color:#000; text-align:left; overflow:hidden; }
      .ticket .t-header{ text-align:center; margin:2px 0; }
      .ticket img{ display:inline-block; max-width:100%; height:auto; }
      .ticket hr{ border:none; border-top:1px dashed #999; margin:6px 0; }
      .ticket .t-row{ display:flex!important; justify-content:space-between; align-items:center; gap:6px; white-space:nowrap!important; margin:2px 0; }
      .ticket .t-desc{ flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap!important; text-align:left; }
      .ticket .t-imp{ flex:0 0 auto; text-align:right; margin-left:8px; white-space:nowrap!important; }
      .ticket .t-totals{ text-align:right; }
      .ticket .t-totals .row{ display:flex; justify-content:flex-end; gap:10px; }
      .ticket .t-thanks{ text-align:center; margin-top:8px; }
      /* === Ajustes de impresiÃ³n solicitados === */
/* Encabezado principal +2 */
.ticket .t-strong{ font-size: calc(var(--ticket-font) + 2px); }

/* Logo +2px (â‰ˆ2pt) */
.ticket .t-header img{ max-width: 142px !important; }

/* InformaciÃ³n del negocio -3 */
.ticket .t-header.biz{ font-size: calc(var(--ticket-font) - 3px); }

/* Info del ticket (folio, fecha, atendiÃ³, cliente, tipo, lÃ­neas, totales, mÃ©todo y pago/cambio) -3 */
.ticket .t-core,
.ticket .t-core *{ font-size: calc(var(--ticket-font) - 3px); }

    }
  </style>
</head>
<body>
  <header>
    <span>POS â€“ Ruta de Venta</span>
    <img src="logo_proveedora.webp" alt="Logo">
  </header>

  <main class="wrap">
    <section class="controls">
      <div class="field">
        <label>Cliente</label>
        <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
        <datalist id="clientesList"></datalist>
      </div>
      <div class="field searchbox">
        <label>Buscar</label>
        <input id="buscador" type="text" placeholder="Escribe o escanea cÃ³digoâ€¦">
        <div id="resultados" class="search-results"></div>
      </div>
      <div class="field">
        <label>Cantidad</label>
        <input id="cantidadInput" type="number" step="0.01" min="0.01" value="1">
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Importe</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="totals">
        <div class="row muted"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
        <div class="row muted"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
        <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
      </div>
    </section>

    <section class="actions">
      <button class="btn" id="btnCobrar">Cobrar</button>
      <button class="btn" id="btnCorte">Corte del dÃ­a</button>
      <!-- NUEVO: botÃ³n para abrir pendientes -->
      <button class="btn" id="btnPendientes" style="background:linear-gradient(180deg,#8a5cff,#5b33cf); margin-top:10px;">Cortes pendientes</button>
    </section>
  </main>

  <!-- Modal de Cobro -->
  <div id="modalCobro">
    <div class="modal-card">
      <div class="modal-h">Cobro</div>
      <div class="modal-b">
        <div class="row big" style="justify-content:space-between">
          <span>Total a pagar:</span>
          <span id="cobroTotal">$0.00</span>
        </div>

        <label for="metodoPago">MÃ©todo de pago</label>
        <select id="metodoPago">
          <option value="efectivo">Efectivo</option>
          <option value="tarjeta">Tarjeta</option>
          <option value="transferencia">Transferencia</option>
          <option value="mixto">Mixto</option>
        </select>

        <!-- Bloque efectivo (se oculta si es tarjeta/transferencia) -->
        <div id="bloqueEfectivo">
          <label for="montoRecibido">Monto recibido</label>
          <input id="montoRecibido" type="number" step="0.01" min="0">
          <div class="row" style="justify-content:space-between">
            <span>Cambio:</span>
            <span id="montoCambio">$0.00</span>
          </div>
        </div>

        <label for="notasCobro">Notas</label>
        <textarea id="notasCobro" rows="2" style="resize:none"></textarea>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn" id="btnCancelarCobro" style="background:#aaa;">Cancelar</button>
          <button class="btn" id="btnConfirmarCobro">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NUEVO: Modal Cortes Pendientes -->
  <div id="modalPendientes" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1200; align-items:center; justify-content:center;">
    <div class="modal-card" style="width:min(720px,94vw);">
      <div class="modal-h" style="display:flex; justify-content:space-between; align-items:center;">
        <span>Cortes pendientes (Ãºltimos 30 dÃ­as)</span>
        <button id="btnCerrarPendientes" class="btn" style="background:#777; width:auto; padding:8px 12px; font-size:14px;">Cerrar</button>
      </div>
      <div class="modal-b" style="gap:12px;">
        <div class="card" style="padding:10px; background:#fff;">
          <div style="overflow:auto; max-height:420px;">
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:#f1f3f6;">Fecha</th>
                  <th style="text-align:right; padding:8px; background:#f1f3f6;">Tickets</th>
                  <th style="text-align:right; padding:8px; background:#f1f3f6;">Total</th>
                  <th style="text-align:center; padding:8px; background:#f1f3f6;">AcciÃ³n</th>
                </tr>
              </thead>
              <tbody id="tbodyPendientes"></tbody>
            </table>
          </div>
          <div id="hintPendientes" style="color:#666; font-size:14px; padding:8px 4px; display:none;">No hay cortes pendientes ðŸŽ‰</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ticket imprimible -->
  <div id="ticketArea">
<div id="ticket" class="ticket">
  <div class="t-header"><img src="logo_proveedora.webp" alt="Logo" style="max-width:140px;"></div>
  <div class="t-header t-strong">La Proveedora</div>
  <div class="t-header t-strong">Ruta de Venta</div>
  <hr>

  <!-- INFO NEGOCIO: ahora con clase 'biz' -->
  <div class="t-header biz">MADERO 690 SUR, CENTRO</div>
  <div class="t-header biz">LINARES, NUEVO LEÃ“N, 67700</div>
  <div class="t-header biz">RFC: PDD-031204-KL5</div>
  <div class="t-header biz">TEL: (821) 2121805</div>
  <div class="t-header biz">RÃ‰GIMEN GENERAL DE LEY</div>
  <div class="t-header biz">PERSONAS MORALES</div>
  <hr>

  <!-- INFO TICKET: -3 con clase 't-core' -->
  <div class="t-header t-core" id="tFolio"></div>
  <div class="t-header t-core" id="tFecha"></div>
  <div class="t-header t-core">AtendiÃ³: <span id="tAtendio"></span></div>
  <hr>

  <div class="t-core" id="tCliente"></div>
  <div class="t-core" id="tTipoRow">Tipo precio: <span id="tTipo"></span></div>
  <hr>

  <div class="t-core" id="tLineas"></div>
  <hr>

  <div class="t-totals t-core">
    <div class="row"><span>Subtotal</span><span id="tSubtotal"></span></div>
    <div class="row"><span>Impuestos</span><span id="tImpuestos"></span></div>
    <div class="row" style="font-weight:700;"><span>Total</span><span id="tTotal"></span></div>
  </div>
  <hr>

  <div class="t-core">MÃ©todo: <span id="tMetodo"></span></div>
  <div class="t-core" id="tRecibidoRow">Pago: <span id="tRecibido"></span> Â· Cambio: <span id="tCambio"></span></div>

  <!-- NOTAS: queda con el tamaÃ±o base (sin -3) -->
  <div id="tNotas"></div>

  <div class="t-header t-strong t-core" style="font-weight:600;">&nbsp;</div>
  <div class="t-thanks">Â¡Gracias por su compra!</div>
</div>
  </div>

<script type="module">
  // ===== Helpers y constantes =====
  const CFDI_DESC = { G01:'AdquisiciÃ³n de mercancÃ­as', G02:'Devoluciones, descuentos y bonificaciones', G03:'Gastos en General', I01:'Construcciones', S01:'Sin efectos fiscales' };
  const cfdiDesc = code => CFDI_DESC[code] || code;

  const pad2 = n => String(n).padStart(2, '0');
  const toYYYYMMDD = (date) => { const d = new Date(date); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
  function rangoUltimosDias(dias = 30){
    const end = new Date(); end.setHours(23,59,59,999);
    const start = new Date(); start.setDate(start.getDate() - (dias-1)); start.setHours(0,0,0,0);
    return { start, end };
  }

  // FunciÃ³n para realizar la bÃºsqueda de productos
  function buscarLocal(qraw){
    const q = (qraw || "").trim();
    if (!q) return [];
    const idByCode = codeIndex.get(q);
    if (idByCode) {
      const p = catalogo.find(x => x.id === idByCode);
      if (p) return [p];
    }
    const nq = normaliza(q);
    return catalogo.filter(p => normaliza(p.nombre).includes(nq));
  }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, setDoc, serverTimestamp, runTransaction, doc,
    getDocs, query, where, orderBy, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "TU_APIKEY",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const $ = (s)=>document.querySelector(s);
  const elCliente = $('#cliente'), elBuscador = $('#buscador'), elCant = $('#cantidadInput');
  const elResultados = $('#resultados'), elTbody = $('#tbody');
  const lblSubtotal = $('#lblSubtotal'), lblTotal = $('#lblTotal'), lblImp = $('#lblImpuestos');

  const ATENDIO  = 'Juan Serrato';
  const rutaId   = 'ruta_1';
  const money = (n)=>'$'+(Number(n)||0).toFixed(2);

  let carrito = [];
  let prodSeleccionado = null;
  let clienteSeleccionado = null;

  let catalogo = [];
  const codeIndex = new Map();
  let clientes = [];
  const normaliza = s => (s||'').toString().trim().toLowerCase();

  /***** Cargar productos *****/
  async function cargarCatalogoDesdeFirestore(){
    catalogo = []; codeIndex.clear();
    const prodSnap = await getDocs(collection(db, 'productos'));
    prodSnap.forEach(d=>{
      const x = d.data();
      if (x.activo === false) return;
      const prod = {
        id: d.id, nombre: x.concepto || 'SIN NOMBRE',
        codigo: (x.codigoBarra||'').toString(),
        precioPublico: Number(x.precioPublico || 0),
        ivaTasa: Number(x.ivaTasa || 0),
        iepsTasa: Number(x.iepsTasa || 0),
        equivalentes:[]
      };
      catalogo.push(prod);
      if(prod.codigo) codeIndex.set(prod.codigo.trim(), prod.id);
    });
  }

  /***** Cargar clientes (incluye uso_cfdi) *****/
  async function cargarClientes(){
    clientes=[]; const dl=document.getElementById("clientesList"); dl.innerHTML="";
    const snap = await getDocs(collection(db,"rutas_venta",rutaId,"clientes"));
    snap.forEach(d=>{
      const c=d.data(); if(c.activo===false) return;
      const cli={
        id:d.id, nombre:c.nombre||"", alias:c.alias||"",
        telefono:c.telefono||"", ciudad:c.ciudad||"", rfc:c.rfc||"",
        ocupa_factura:!!c.ocupa_factura, uso_cfdi: c.uso_cfdi || ""
      };
      clientes.push(cli);
      const opt=document.createElement("option");
      opt.value=cli.nombre;
      opt.label=cli.alias ? `${cli.nombre} (${cli.alias})` : cli.nombre;
      dl.appendChild(opt);
    });
  }
  elCliente.addEventListener("change",()=>{
    const v=normaliza(elCliente.value);
    clienteSeleccionado=clientes.find(c=>normaliza(c.nombre)===v)||null;
  });

  const priceOf = p => Number(p.precioPublico||0);

  /***** Totales con impuestos incluidos *****/
  function calcularTotalesConImpuestosIncluidos(){
    let total=0, impuestos=0;
    carrito.forEach(it=>{
      const imp=it.cantidad*it.precioUnit;
      total+=imp;
      if(it.ivaTasa>0) impuestos+=(imp*it.ivaTasa)/(1+it.ivaTasa);
      if(it.iepsTasa>0) impuestos+=(imp*it.iepsTasa)/(1+it.iepsTasa);
    });
    const subtotal=total-impuestos;
    return {subtotal:+subtotal.toFixed(2), impuestos:+impuestos.toFixed(2), total:+total.toFixed(2)};
  }

  /***** Render tabla *****/
  function render(){
    elTbody.innerHTML="";
    carrito.forEach(it=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${it.nombre}</td>
        <td>${it.cantidad.toFixed(2)}</td>
        <td>${money(it.importe)}</td>
        <td class="del-col"><button class="del" title="Quitar">âœ•</button></td>`;
      tr.querySelector('.del').onclick=()=>delItem(it.id);
      elTbody.appendChild(tr);
    });
    const {subtotal,impuestos,total}=calcularTotalesConImpuestosIncluidos();
    lblSubtotal.textContent=money(subtotal);
    lblImp.textContent=money(impuestos);
    lblTotal.textContent=money(total);
  }

  // eliminar lÃ­nea del carrito
  function delItem(id){
    carrito = carrito.filter(x=>x.id!==id);
    render();
  }

  // Agregar producto
  function addProduct(prod, cantidad = 1){
    if(!prod) return;
    const cant = Math.max(0.01, Number(cantidad) || 1);
    const precio = priceOf(prod);
    const ex = carrito.find(x => x.id === prod.id);
    if(ex) { ex.cantidad += cant; ex.importe = ex.cantidad * precio; }
    else { carrito.push({...prod, cantidad:cant, precioUnit:precio, importe:cant*precio}); }
    render();
  }

  // Resultados de bÃºsqueda
  elBuscador.addEventListener('input', () => { pintarResultados(buscarLocal(elBuscador.value)); });
  function pintarResultados(hits){
    elResultados.innerHTML="";
    if(hits.length===0){ elResultados.style.display="none"; return; }
    elResultados.style.display="block";
    hits.forEach(p => {
      const div = document.createElement("div");
      div.className = "result-item";
      div.innerHTML = `<span>${p.nombre}</span><span><small>${p.codigo}</small> ${money(priceOf(p))}</span>`;
      // Seleccionar y pasar a cantidad
      div.onclick = () => {
        prodSeleccionado = p;
        elBuscador.value = p.nombre;
        elResultados.style.display = "none";
        elCant.focus(); elCant.select();
      };
      elResultados.appendChild(div);
    });
  }
  elBuscador.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') {
      const hits = buscarLocal(elBuscador.value.trim());
      if (hits.length >= 1) {
        prodSeleccionado = hits[0];
        elResultados.style.display = "none";
        elBuscador.value = hits[0].nombre;
        elCant.focus(); elCant.select();
      }
    }
  });
  elCant.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') {
      if (!clienteSeleccionado){ alert('Selecciona un cliente primero.'); elCliente.focus(); return; }
      if (!prodSeleccionado)   { alert('Primero selecciona un producto.'); elBuscador.focus(); return; }
      const cant = parseFloat(elCant.value || '');
      if (isNaN(cant) || cant <= 0) { alert('Ingresa una cantidad vÃ¡lida.'); elCant.focus(); elCant.select(); return; }
      addProduct(prodSeleccionado, cant);
      // reset
      prodSeleccionado = null;
      elBuscador.value = '';
      elCant.value = '1';
      elBuscador.focus();
    }
  });

  /***** Cobro + Firestore *****/
  const modalCobro = document.getElementById('modalCobro');
  const cobroTotal = document.getElementById('cobroTotal');
  const metodoPago = document.getElementById('metodoPago');
  const bloqueEfectivo = document.getElementById('bloqueEfectivo');
  const montoRecibido = document.getElementById('montoRecibido');
  const montoCambio = document.getElementById('montoCambio');
  const notasCobro = document.getElementById('notasCobro');

  function abrirCobro(){
    if(carrito.length===0){ alert('Agrega productos primero'); return; }
    elResultados.style.display='none';
    document.body.classList.add('modal-open');
    const { total } = calcularTotalesConImpuestosIncluidos()
    cobroTotal.textContent = money(total);
    montoRecibido.value=''; montoCambio.textContent=money(0);
    notasCobro.value=''; metodoPago.value='efectivo'; bloqueEfectivo.style.display='block';
    modalCobro.style.display='flex';
    setTimeout(()=>montoRecibido.focus(), 50);
  }
  function cerrarCobro(){ modalCobro.style.display='none'; document.body.classList.remove('modal-open'); }
  metodoPago.addEventListener('change', ()=>{
    const isCash = metodoPago.value==='efectivo' || metodoPago.value==='mixto';
    bloqueEfectivo.style.display = isCash ? 'block' : 'none';
  });
  montoRecibido.addEventListener('input', ()=>{
    const { total } = calcularTotalesConImpuestosIncluidos();
    const recibidoX = parseFloat(montoRecibido.value||'0');
    const cambio = Math.max(0, recibidoX - total);
    montoCambio.textContent = money(cambio);
  });

  async function getNextFolio(db){
    const ref = doc(db, 'consecutivos', rutaId);
    const folio = await runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref);
      if(!snap.exists()){ tx.set(ref,{valor:1,actualizado:serverTimestamp()}); return 1; }
      const actual = Number(snap.data().valor||0)+1;
      tx.update(ref,{valor:actual, actualizado:serverTimestamp()});
      return actual;
    });
    return `RV-${String(folio).padStart(6,'0')}`;
  }
  async function guardarVentaEnFirestore(payload){
    const col = collection(db, 'rutas_venta', rutaId, 'ventas');
    const docRef = await addDoc(col, payload);
    return docRef.id;
  }

  // ---- Ticket ----
  function rellenarTicket({folio, fechaTxt, clienteTxt, metodo, recibido, cambio, notas}){
    document.getElementById('tFolio').textContent = `Folio: ${folio}`;
    document.getElementById('tFecha').textContent = fechaTxt;
    document.getElementById('tAtendio').textContent = ATENDIO;

    const partes = [];
    partes.push(`Cliente: ${clienteTxt}`);
    if(clienteSeleccionado){
      if(clienteSeleccionado.telefono) partes.push(`Tel: ${clienteSeleccionado.telefono}`);
      if(clienteSeleccionado.ciudad)   partes.push(clienteSeleccionado.ciudad);
    }
    document.getElementById('tCliente').textContent = partes.join(' Â· ');
    document.getElementById('tTipo').textContent = "PÃºblico";

    const tLineas = document.getElementById('tLineas');
    tLineas.innerHTML='';
    carrito.forEach(it=>{
      const fila = document.createElement('div');
      fila.className='t-row';
      const desc = document.createElement('span');
      desc.className='t-desc';
      desc.textContent = `${it.cantidad.toFixed(2)} ${it.nombre}`;
      const imp = document.createElement('span');
      imp.className='t-imp';
      imp.textContent = money(it.importe);
      fila.appendChild(desc); fila.appendChild(imp);
      tLineas.appendChild(fila);
    });

    const { subtotal, impuestos, total } = calcularTotalesConImpuestosIncluidos();
    document.getElementById('tSubtotal').textContent = money(subtotal);
    document.getElementById('tImpuestos').textContent = money(impuestos);
    document.getElementById('tTotal').textContent = money(total);

    document.getElementById('tMetodo').textContent = metodo.toUpperCase();
    const rRow = document.getElementById('tRecibidoRow');
    if(metodo==='efectivo' || metodo==='mixto'){
      rRow.style.display='block';
      document.getElementById('tRecibido').textContent = money(recibido);
      document.getElementById('tCambio').textContent = money(cambio);
    }else{
      rRow.style.display='none';
    }

    const notasExtra = [];
    if(clienteSeleccionado){
      notasExtra.push(`Factura: ${clienteSeleccionado.ocupa_factura ? 'SÃ­' : 'No'}`);
      if(clienteSeleccionado.ocupa_factura && clienteSeleccionado.rfc){
        notasExtra.push(`RFC: ${clienteSeleccionado.rfc}`);
      }
      if(clienteSeleccionado.ocupa_factura && clienteSeleccionado.uso_cfdi){
        notasExtra.push(`Uso CFDI: ${cfdiDesc(clienteSeleccionado.uso_cfdi)} (${clienteSeleccionado.uso_cfdi})`);
      }
    }
    if(notas && notas.trim()) notasExtra.push(`Notas: ${notas.trim()}`);
    document.getElementById('tNotas').textContent = notasExtra.join(' Â· ');
  }

  async function confirmarCobro(){
    try{
      const { subtotal, impuestos, total } = calcularTotalesConImpuestosIncluidos();
      const clienteTxt = elCliente.value || 'Mostrador';
      const metodo = metodoPago.value;

      const recibido = parseFloat(montoRecibido.value||'0');
      if(metodo==='efectivo' || metodo==='mixto'){
        if(recibido < total){ alert('El pago recibido es menor que el total.'); return; }
      }
      const cambio = Math.max(0, recibido - total);
      const notas = (notasCobro.value||'').trim();

      const folio = await getNextFolio(db);
      const fecha = new Date(); 
      const fechaTxt = fecha.toLocaleString();
      const fecha_dia = toYYYYMMDD(fecha); // NUEVO

      const venta = {
        folio, rutaId,
        fecha: serverTimestamp(), fecha_txt: fechaTxt, fecha_dia, // NUEVO
        cliente: clienteTxt,
        cliente_info: clienteSeleccionado ? {
          id: clienteSeleccionado.id,
          ocupa_factura: !!clienteSeleccionado.ocupa_factura,
          rfc: clienteSeleccionado.rfc || '',
          telefono: clienteSeleccionado.telefono || '',
          ciudad: clienteSeleccionado.ciudad || '',
          estado: clienteSeleccionado.estado || '',
          cp: clienteSeleccionado.cp || '',
          direccion: clienteSeleccionado.direccion || '',
          uso_cfdi: clienteSeleccionado.uso_cfdi || ''  // guardado
        } : null,
        atendio: ATENDIO,
        tipo_precio: "publico",
        metodo_pago: metodo,
        recibido: (metodo==='efectivo'||metodo==='mixto') ? recibido : 0,
        cambio:   (metodo==='efectivo'||metodo==='mixto') ? cambio   : 0,
        subtotal, impuestos, total,
        notas,
        detalle: carrito.map(it=>({
          id: it.id, nombre: it.nombre, cantidad: it.cantidad,
          precio_unit: it.precioUnit, importe: it.importe,
          iva_tasa: Number(it.ivaTasa||0),
          ieps_tasa: Number(it.iepsTasa||0),
          precio_publico: it.precioPublico
        }))
      };

      const docId = await guardarVentaEnFirestore(venta);

      rellenarTicket({folio, fechaTxt, clienteTxt, metodo, recibido, cambio, notas});
      window.print();

      carrito = []; render(); cerrarCobro();

      const ventas = JSON.parse(localStorage.getItem('pos_ruta_ventas')||'[]');
      ventas.push({docId, ...venta, fecha_txt: fechaTxt});
      localStorage.setItem('pos_ruta_ventas', JSON.stringify(ventas));
    }catch(err){
      console.error(err);
      alert('No se pudo guardar la venta en Firebase. Revisa conexiÃ³n y vuelve a intentar.');
    }
  }

  /***** Cortes por dÃ­a *****/
  async function calcularResumenDeDia(dateStr){
    const [Y,M,D] = dateStr.split('-').map(Number);
    const start = new Date(Y, M-1, D, 0,0,0,0);
    const end   = new Date(Y, M-1, D, 23,59,59,999);
    const tsStart = Timestamp.fromDate(start);
    const tsEnd   = Timestamp.fromDate(end);

    const ventasRef = collection(db, 'rutas_venta', rutaId, 'ventas');
    const qv = query(ventasRef, where('fecha','>=', tsStart), where('fecha','<', tsEnd), orderBy('fecha','asc'));
    const snap = await getDocs(qv);

    let total = 0, conteo = 0;
    const desg = { efectivo:0, tarjeta:0, transferencia:0, mixto:0 };
    snap.forEach(s=>{
      const v = s.data(); const t = Number(v.total||0);
      total += t; conteo += 1;
      const m = (v.metodo_pago||'').toLowerCase();
      if(m==='efectivo') desg.efectivo += t;
      else if(m==='tarjeta') desg.tarjeta += t;
      else if(m==='transferencia') desg.transferencia += t;
      else if(m==='mixto') desg.mixto += t;
    });
    return { total, conteo, desg };
  }

  async function generarCorteParaDia(dateStr){
    try{
      const { total, conteo, desg } = await calcularResumenDeDia(dateStr);
      if(conteo === 0){ alert(`No hay ventas en ${dateStr}.`); return; }

      const folioCorte = `C-${dateStr.replaceAll('-','')}`;
      const fechaTxt = new Date().toLocaleString();

      document.getElementById('tFolio').textContent = `CORTE: ${folioCorte}`;
      document.getElementById('tFecha').textContent = fechaTxt;
      document.getElementById('tAtendio').textContent = ATENDIO;
      document.getElementById('tCliente').textContent = `Ruta: ${rutaId}`;
      document.getElementById('tTipo').textContent = `Corte del dÃ­a ${dateStr}`;

      const tLineas = document.getElementById('tLineas'); 
      tLineas.innerHTML='';
      const mk = (l,r)=>{ const d=document.createElement('div'); d.className='t-row';
        const a=document.createElement('span'); a.className='t-desc'; a.textContent=l;
        const b=document.createElement('span'); b.className='t-imp'; b.textContent=money(r);
        d.appendChild(a); d.appendChild(b); return d; };
      tLineas.appendChild(mk('EFECTIVO',desg.efectivo));
      tLineas.appendChild(mk('TARJETA',desg.tarjeta));
      tLineas.appendChild(mk('TRANSFER',desg.transferencia));
      tLineas.appendChild(mk('MIXTO',desg.mixto));

      document.getElementById('tSubtotal').textContent = money(total);
      document.getElementById('tImpuestos').textContent = money(0);
      document.getElementById('tTotal').textContent = money(total);
      document.getElementById('tMetodo').textContent = 'â€”';
      document.getElementById('tRecibidoRow').style.display='none';
      document.getElementById('tNotas').textContent = 'Fin de dÃ­a';

      window.print();

      const corteRef = doc(db, 'rutas_venta', rutaId, 'cortes', dateStr);
      await setDoc(corteRef, { fecha_dia: dateStr, total, tickets: conteo, desglose: desg, atendio: ATENDIO, creado: serverTimestamp() });

      if (document.getElementById('modalPendientes').style.display === 'flex'){ await listarCortesPendientes(); }
      alert(`Corte de ${dateStr} registrado.`);
    }catch(err){
      console.error(err);
      alert('No se pudo generar/guardar el corte.');
    }
  }

  async function corteDelDia(){
    const hoy = toYYYYMMDD(new Date());
    await generarCorteParaDia(hoy);
  }

  async function listarCortesPendientes(){
    const { start, end } = rangoUltimosDias(30);
    const tsStart = Timestamp.fromDate(start);
    const tsEnd   = Timestamp.fromDate(end);

    const ventasRef = collection(db, 'rutas_venta', rutaId, 'ventas');
    const qv = query(ventasRef, where('fecha','>=', tsStart), where('fecha','<', tsEnd));
    const snapV = await getDocs(qv);

    const porDia = new Map();
    snapV.forEach(s=>{
      const v = s.data();
      const d = v.fecha_dia || toYYYYMMDD((v.fecha && v.fecha.toDate) ? v.fecha.toDate() : new Date(v.fecha_txt || Date.now()));
      const t = Number(v.total||0);
      const cur = porDia.get(d) || { total:0, tickets:0 };
      cur.total += t; cur.tickets += 1;
      porDia.set(d, cur);
    });

    const cortesRef = collection(db, 'rutas_venta', rutaId, 'cortes');
    const qc = query(cortesRef, where('fecha_dia','>=', toYYYYMMDD(start)), where('fecha_dia','<=', toYYYYMMDD(end)));
    const snapC = await getDocs(qc);
    const cerrados = new Set();
    snapC.forEach(c=>{ const x=c.data(); if(x && x.fecha_dia) cerrados.add(x.fecha_dia); });

    const pendientes = Array.from(porDia.entries())
      .filter(([d]) => !cerrados.has(d))
      .sort((a,b)=> a[0] < b[0] ? 1 : -1);

    const tbody = document.getElementById('tbodyPendientes');
    const hint  = document.getElementById('hintPendientes');
    tbody.innerHTML = '';

    if(pendientes.length === 0){ hint.style.display = 'block'; return; }
    hint.style.display = 'none';

    pendientes.forEach(([fecha_dia, data])=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:8px;">${fecha_dia}</td>
        <td style="padding:8px; text-align:right;">${data.tickets}</td>
        <td style="padding:8px; text-align:right;">${money(data.total)}</td>
        <td style="padding:8px; text-align:center;">
          <button class="btn btn-gen" data-dia="${fecha_dia}" style="width:auto; padding:8px 12px; font-size:14px;">Generar corte</button>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.btn-gen').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        const dia = ev.currentTarget.getAttribute('data-dia');
        await generarCorteParaDia(dia);
      });
    });
  }

  function abrirModalPendientes(){
    const modal = document.getElementById('modalPendientes');
    document.body.classList.add('modal-open');
    modal.style.display = 'flex';
    listarCortesPendientes();
  }
  function cerrarModalPendientes(){
    const modal = document.getElementById('modalPendientes');
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
  }

  // Botones
  document.getElementById('btnCobrar').onclick = abrirCobro;
  document.getElementById('btnCancelarCobro').onclick = cerrarCobro;
  document.getElementById('btnConfirmarCobro').onclick = confirmarCobro;
  document.getElementById('btnCorte').onclick = corteDelDia;
  document.getElementById('btnPendientes').onclick = abrirModalPendientes;
  document.getElementById('btnCerrarPendientes').onclick = cerrarModalPendientes;

  await cargarCatalogoDesdeFirestore();
  await cargarClientes();
  render();
</script>
</body>
</html>


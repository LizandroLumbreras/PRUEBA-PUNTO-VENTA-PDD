<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POS – Ruta de Venta</title>
  <link rel="icon" href="logo_proveedora.webp">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --ok:#1e8e3e; --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9); --muted:rgba(0,0,0,.55); --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Arial; color:#111; background:var(--bg-grad);
      display:flex; flex-direction:column;
    }

    header{
      position:sticky; top:0; z-index:50;
      background:rgba(0,0,0,.6);
      color:#fff;
      padding:10px 14px;
      display:flex; justify-content:center; align-items:center; gap:8px;
      font-weight:700; font-size:18px;
      backdrop-filter:saturate(120%) blur(4px);
      height:50px;
    }
    header img{ height:75px; object-fit:contain; }

    .wrap{flex:1; padding:12px; display:flex; flex-direction:column; gap:12px; max-width:720px; margin:0 auto}
    .controls{ display:flex; flex-direction:column; gap:10px; }
    .field{
      display:flex; gap:8px; background:rgba(255,255,255,.12); padding:10px; border-radius:var(--radius-sm);
      align-items:center;
    }
    .field label{min-width:78px; color:#fff; font-size:13px}
    .field input{ flex:1; padding:10px 12px; border:none; border-radius:8px; font-size:15px; background:#fff; outline:none; }

    .searchbox{ position:relative; z-index:300; }
    .search-results{
      position:absolute; left:90px; right:10px; top:calc(100% + 6px);
      background:#fff; border-radius:12px; box-shadow:var(--shadow);
      max-height:260px; overflow:auto; display:none; z-index:310;
    }
    .result-item{ padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px }
    .result-item small{ color:var(--muted) }
    .result-item:hover{ background:#f2f4f7 }

    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .table-wrap{ max-height:260px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    thead th{ background:var(--azul); color:#fff; padding:10px; font-size:13px; position:sticky; top:0; z-index:100; }
    thead th:nth-child(1){ width:55%; text-align:left; }
    thead th:nth-child(2){ width:15%; text-align:center; }
    thead th:nth-child(3){ width:20%; text-align:right; }
    thead th:nth-child(4){ width:10%; text-align:center; }
    td.del-col{ text-align:center; }
    td.del-col .del{background:#e74c3c; color:#fff; border:none; border-radius:50%; width:22px; height:22px; font-size:14px; line-height:20px; cursor:pointer;}
    td.del-col .del:hover{ background:#c0392b; }

    .totals{ display:flex; flex-direction:column; gap:6px; padding:12px 14px; background:#fff; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:15px }
    .row.muted{ color:var(--muted) }
    .row.big{ font-weight:700; font-size:18px }

    .actions{ padding:6px 0 12px }
    .btn{
      width:100%; border:none; padding:14px; border-radius:12px; font-size:18px; font-weight:700; color:#fff;
      background:linear-gradient(180deg,var(--resalte),#094d85); box-shadow:var(--shadow); cursor:pointer;
    }
    #btnCorte{ background:linear-gradient(180deg,#1e8e3e,#146329); margin-top:10px; }

    #ticketArea{ display:none; }
    @media print{
      :root{ --ticket-mm:72; --ticket-pad-mm:1; --ticket-font:18px; --line-height:1.08; }
      @page{ size: calc(var(--ticket-mm) * 1mm) auto; margin:0; }
      html,body{ background:#fff!important; height:auto!important; width:calc(var(--ticket-mm) * 1mm); margin:0!important; padding:0!important; }
      body *{ visibility:hidden!important; }
      #ticketArea, #ticketArea *{ visibility:visible!important; }
      #ticketArea{ position:fixed; inset:0; display:block!important; background:#fff!important; }
      .ticket{ width:calc(var(--ticket-mm) * 1mm); margin:0 auto; }
    }

    /* === LOGO FLOTANTE CON FONDO === */
    #overlayLogo {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5000;
    }
    #logoFlotante {
      transform: scale(0.8);
      opacity: 0;
      transition: all 0.4s ease-in-out;
    }
    #overlayLogo.mostrar #logoFlotante {
      opacity: 1;
      transform: scale(1);
    }
  </style>
</head>
<body>
  <header>
    <span>POS – Ruta de Venta</span>
    <img src="logo_proveedora.webp" alt="Logo">
  </header>

  <main class="wrap">
    <section class="controls">
      <div class="field">
        <label>Cliente</label>
        <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
        <datalist id="clientesList"></datalist>
      </div>
      <div class="field searchbox">
        <label>Buscar</label>
        <input id="buscador" type="text" placeholder="Escribe o escanea código…">
        <div id="resultados" class="search-results"></div>
      </div>
      <div class="field">
        <label>Cantidad</label>
        <input id="cantidadInput" type="number" step="0.01" min="0.01" value="1">
      </div>
    </section>

    <section class="actions">
      <button class="btn" id="btnCobrar">Cobrar</button>
      <button class="btn" id="btnCorte">Corte del día</button>
    </section>
  </main>

  <!-- Ticket -->
  <div id="ticketArea">
    <div id="ticket" class="ticket">
      <div class="t-header"><img src="logo_proveedora.webp" alt=""></div>
      <div class="t-header t-strong">La Proveedora</div>
      <div class="t-header t-strong">Ruta de Venta</div>
      <hr>
      <div class="t-header t-core" id="tFolio"></div>
      <div class="t-header t-core" id="tFecha"></div>
      <div class="t-header t-core">Atendió: <span id="tAtendio"></span></div>
      <hr>
      <div class="t-core" id="tCliente"></div>
      <div class="t-core" id="tLineas"></div>
      <hr>
      <div class="t-totals t-core">
        <div class="row"><span>Total</span><span id="tTotal"></span></div>
      </div>
      <div id="tNotas"></div>
      <div class="t-thanks">¡Gracias por su compra!</div>
    </div>
  </div>

  <!-- Overlay con logo -->
  <div id="overlayLogo"><img id="logoFlotante" src="logo_proveedora.webp" width="180" alt=""></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, orderBy, doc, setDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const ATENDIO='Juan Serrato', rutaId='ruta_1';
const $=s=>document.querySelector(s);
const toYYYYMMDD=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const money=n=>'$'+(Number(n)||0).toFixed(2);

// === Catálogo global + util de normalización ===
let CATALOGO = [];
const normaliza = s => (s||'')
  .toString()
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
  .toLowerCase().trim();

/* ===== Clientes ===== */
async function cargarClientes(){
  const snap=await getDocs(collection(db,"rutas_venta",rutaId,"clientes"));
  const dl=document.getElementById("clientesList");
  dl.innerHTML="";
  snap.forEach(d=>{
    const c=d.data();
    const opt=document.createElement("option");
    opt.value=c.nombre||"";
    dl.appendChild(opt);
  });
  console.log("Clientes cargados:", snap.size);
}

/* ===== Productos ===== */
async function cargarCatalogo(){
  const snap=await getDocs(collection(db,"productos"));
  CATALOGO = [];
  snap.forEach(d=>{
    const x=d.data();
    CATALOGO.push({
      id:d.id,
      nombre:x.concepto || "SIN NOMBRE",
      codigo:(x.codigoBarra || x.codigo || "").toString()
    });
  });
  console.log("Productos cargados:", CATALOGO.length);
}

/* ===== Buscador ===== */
const $buscador  = document.getElementById('buscador');
const $resultados = document.getElementById('resultados');

function renderResultados(items){
  if(!items || items.length===0){
    $resultados.style.display = 'none';
    $resultados.innerHTML = '';
    return;
  }
  $resultados.innerHTML = items.slice(0,50).map(p=>`
    <div class="result-item" data-id="${p.id}">
      <div>
        <div>${p.nombre}</div>
        <small>${p.codigo||''}</small>
      </div>
    </div>
  `).join('');
  $resultados.style.display = 'block';
}

function filtrarCatalogo(q){
  const qn = normaliza(q);
  if(!qn) return [];
  return CATALOGO.filter(p=>{
    const n = normaliza(p.nombre);
    const c = normaliza(p.codigo);
    return n.includes(qn) || c.includes(qn);
  });
}

let tSearch;
$buscador.addEventListener('input', e=>{
  clearTimeout(tSearch);
  const val = e.target.value;
  tSearch = setTimeout(()=>{
    const res = filtrarCatalogo(val);
    renderResultados(res);
  }, 120);
});

$resultados.addEventListener('click', e=>{
  const item = e.target.closest('.result-item');
  if(!item) return;
  const id = item.getAttribute('data-id');
  const prod = CATALOGO.find(p=>p.id===id);
  if(!prod) return;

  $buscador.value = `${prod.codigo} - ${prod.nombre}`;
  $resultados.style.display = 'none';
  console.log('Seleccionado:', prod);
  // TODO: aquí puedes agregar al carrito / línea de venta
});

document.addEventListener('click', (e)=>{
  if(!e.target.closest('.searchbox')) $resultados.style.display = 'none';
});

// Enter = toma el primer resultado
$buscador.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const res = filtrarCatalogo($buscador.value);
    if(res.length){
      const p = res[0];
      $buscador.value = `${p.codigo} - ${p.nombre}`;
      $resultados.style.display = 'none';
      console.log('Seleccionado (Enter):', p);
      e.preventDefault();
    }
  }
});

/* ===== Corte ===== */
async function calcularResumenDeDia(dateStr){
  const [Y,M,D]=dateStr.split('-').map(Number);
  const start=new Date(Y,M-1,D,0,0,0), end=new Date(Y,M-1,D,23,59,59);
  const tsStart=Timestamp.fromDate(start), tsEnd=Timestamp.fromDate(end);
  const qv=query(collection(db,'rutas_venta',rutaId,'ventas'),
                 where('fecha','>=',tsStart),
                 where('fecha','<',tsEnd),
                 orderBy('fecha','asc'));
  const snap=await getDocs(qv);
  let total=0;
  snap.forEach(s=> total += Number(s.data().total||0));
  return {total,conteo:snap.size};
}

async function guardarCorte(dateStr){
  const {total,conteo}=await calcularResumenDeDia(dateStr);
  if(conteo===0){ alert("No hay ventas en "+dateStr); return false; }
  await setDoc(doc(db,'rutas_venta',rutaId,'cortes',dateStr),{
    fecha_dia:dateStr,total,tickets:conteo,atendio:ATENDIO,creado:serverTimestamp()
  });
  return true;
}

async function imprimirCorte(dateStr){
  const {total,conteo}=await calcularResumenDeDia(dateStr);
  if(conteo===0)return;
  $('#tFolio').textContent="CORTE "+dateStr;
  $('#tFecha').textContent=new Date().toLocaleString();
  $('#tAtendio').textContent=ATENDIO;
  $('#tCliente').textContent="Ruta: "+rutaId;
  $('#tTotal').textContent=money(total);
  $('#tNotas').textContent="Fin de día";
  window.print();
}

async function corteDelDia(){
  const seguro=confirm("¿Está seguro de realizar el corte del día?");
  if(!seguro)return;
  const overlay=$("#overlayLogo");
  overlay.style.display="flex";
  overlay.classList.add("mostrar");
  const hoy=toYYYYMMDD(new Date());
  const guardado=await guardarCorte(hoy);
  setTimeout(async()=>{
    overlay.classList.remove("mostrar");
    overlay.style.display="none";
    if(guardado) await imprimirCorte(hoy);
  },5000);
}

/* ===== Inicialización ===== */
document.getElementById("btnCorte").onclick=corteDelDia;
// (Opcional) placeholder de Cobrar:
document.getElementById("btnCobrar").onclick=()=>alert("Cobrar: integra aquí tu flujo de ticket/carrito.");

await cargarClientes();
await cargarCatalogo();
</script>
</body>
</html>

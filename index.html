<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POS – Ruta de Venta</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --ok:#1e8e3e; --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9); --muted:rgba(0,0,0,.55); --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Poppins',system-ui,Arial; color:#111; background:var(--bg-grad);
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{
      background:rgba(0,0,0,.6); color:#fff; padding:10px; text-align:center;
      font-weight:700; font-size:18px; display:flex; justify-content:center; gap:8px;
    }
    header img{ height:34px; }

    .wrap{flex:1; padding:12px; max-width:720px; margin:auto; display:flex; flex-direction:column; gap:12px;}
    .field{ display:flex; gap:8px; padding:10px; background:rgba(255,255,255,.15); border-radius:10px; align-items:center;}
    .field label{ color:#fff; font-size:14px; min-width:80px; }
    .field input{ flex:1; padding:10px; border:none; border-radius:8px; }

    .card{ background:var(--card); border-radius:14px; box-shadow:var(--shadow); overflow:hidden; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background:var(--azul); color:#fff; padding:8px; font-size:13px; }
    thead th:nth-child(1){width:55%; text-align:left;}
    thead th:nth-child(2){width:15%; text-align:center;}
    thead th:nth-child(3){width:20%; text-align:right;}
    thead th:nth-child(4){width:10%; text-align:center;}
    td{text-align:center; padding:4px;}
    td button{ background:#e74c3c; border:none; color:#fff; border-radius:50%; width:22px; height:22px; cursor:pointer; }

    .totals{ background:#fff; padding:10px; display:flex; flex-direction:column; gap:4px;}
    .row{display:flex; justify-content:space-between;}
    .row.big{font-weight:700; font-size:18px;}

    .btn{width:100%; padding:12px; border:none; border-radius:12px; font-weight:700; color:#fff; cursor:pointer;}
    #btnCobrar{background:linear-gradient(180deg,#0c6cbd,#094d85);}
    #btnCorte{background:linear-gradient(180deg,#1e8e3e,#146329); margin-top:10px;}

    /* ====== Ticket ====== */
    #ticketArea{display:none;}
    @media print{
      @page{size:58mm auto; margin:0;}
      body *{visibility:hidden;}
      #ticketArea, #ticketArea *{visibility:visible;}
      #ticketArea{position:fixed; inset:0; display:block!important;}
      .ticket{width:58mm; padding:2mm; font:13px/1.25 'Poppins',sans-serif;}
      .ticket .t-header{text-align:center; margin:4px 0;}
      .ticket hr{border:none; border-top:1px dashed #999; margin:4px 0;}
      .t-row{display:flex; justify-content:space-between;}
    }
  </style>
</head>
<body>
  <header>
    <span>POS – Ruta de Venta</span>
    <img src="logo_proveedora.webp" alt="Logo">
  </header>

  <main class="wrap">
    <section class="controls">
      <div class="field"><label>Cliente</label><input id="cliente" type="text" placeholder="Nombre del cliente"></div>
      <div class="field"><label>Buscar</label><input id="buscador" type="text" placeholder="Escribe o escanea código…"></div>
      <div class="field"><label>Cantidad</label><input id="cantidadInput" type="number" step="0.01" min="0.01" value="1"></div>
    </section>

    <section class="card">
      <table>
        <thead><tr><th>Producto</th><th>Cant.</th><th>Importe</th><th></th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="totals">
        <div class="row"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
        <div class="row"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
        <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
      </div>
    </section>

    <section>
      <button class="btn" id="btnCobrar">Cobrar</button>
      <button class="btn" id="btnCorte">Corte del día</button>
    </section>
  </main>

  <!-- Ticket -->
  <div id="ticketArea">
    <div class="ticket">
      <div class="t-header"><img src="logo_proveedora.webp" style="max-width:140px;"></div>
      <div class="t-header">La Proveedora – Ruta de Venta</div>
      <hr>
      <div id="tFolio"></div>
      <div id="tFecha"></div>
      <hr>
      <div id="tLineas"></div>
      <hr>
      <div class="t-totals">
        <div class="row"><span>Subtotal</span><span id="tSubtotal"></span></div>
        <div class="row"><span>Impuestos</span><span id="tImpuestos"></span></div>
        <div class="row big"><span>Total</span><span id="tTotal"></span></div>
      </div>
    </div>
  </div>
 <script type="module">
/***** Firebase *****/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, serverTimestamp, runTransaction, doc,
  getDocs, query, where, orderBy, Timestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/***** Estado/UI *****/
const $ = (s)=>document.querySelector(s);
const elCliente = $('#cliente'), elBuscador = $('#buscador'), elCant = $('#cantidadInput');
const elTbody = $('#tbody');
const lblSubtotal = $('#lblSubtotal'), lblImpuestos = $('#lblImpuestos'), lblTotal = $('#lblTotal');
const money = (n)=>'$'+(Number(n)||0).toFixed(2);

let carrito = [];
let catalogo = [];
const codeIndex = new Map();
const rutaId = "ruta_1";
const ATENDIO = "Juan Serrato";

/***** Cargar productos desde Firestore *****/
async function cargarCatalogo(){
  catalogo = []; codeIndex.clear();
  const snap = await getDocs(collection(db,"productos"));
  snap.forEach(d=>{
    const x=d.data();
    if(x.activo===false) return;
    const prod={
      id:d.id,
      nombre:x.concepto||"SIN NOMBRE",
      codigo:(x.codigoBarra||"").toString(),
      precioPublico:Number(x.precioPublico||0),
      ivaTasa:Number(x.ivaTasa||0),
      iepsTasa:Number(x.iepsTasa||0)
    };
    catalogo.push(prod);
    if(prod.codigo) codeIndex.set(prod.codigo,prod.id);
  });
}

/***** Totales *****/
function calcularTotales(){
  let total=0, impuestos=0;
  carrito.forEach(it=>{
    const imp=it.cantidad*it.precioUnit;
    total+=imp;
    if(it.ivaTasa>0) impuestos+=(imp*it.ivaTasa)/(1+it.ivaTasa);
    if(it.iepsTasa>0) impuestos+=(imp*it.iepsTasa)/(1+it.iepsTasa);
  });
  const subtotal=total-impuestos;
  return {subtotal:+subtotal.toFixed(2), impuestos:+impuestos.toFixed(2), total:+total.toFixed(2)};
}

/***** Render tabla *****/
function render(){
  elTbody.innerHTML="";
  carrito.forEach(it=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${it.nombre}</td>
      <td>${it.cantidad.toFixed(2)}</td>
      <td>${money(it.importe)}</td>
      <td><button onclick="delItem('${it.id}')">✕</button></td>`;
    elTbody.appendChild(tr);
  });
  const {subtotal,impuestos,total}=calcularTotales();
  lblSubtotal.textContent=money(subtotal);
  lblImpuestos.textContent=money(impuestos);
  lblTotal.textContent=money(total);
}
window.delItem=id=>{ carrito=carrito.filter(x=>x.id!==id); render(); }

/***** Agregar producto *****/
function addProduct(prod,cantidad=1){
  const cant=Math.max(0.01,Number(cantidad)||1);
  const ex=carrito.find(x=>x.id===prod.id);
  if(ex){
    ex.cantidad+=cant;
    ex.importe=+(ex.cantidad*ex.precioUnit).toFixed(2);
  }else{
    carrito.push({
      id:prod.id, nombre:prod.nombre,
      cantidad:cant,
      precioUnit:prod.precioPublico,
      importe:+(cant*prod.precioPublico).toFixed(2),
      ivaTasa:prod.ivaTasa, iepsTasa:prod.iepsTasa
    });
  }
  render();
}

/***** Cobro *****/
async function getNextFolio(){
  const ref=doc(db,"consecutivos",rutaId);
  const folio=await runTransaction(db,async(tx)=>{
    const snap=await tx.get(ref);
    if(!snap.exists()){tx.set(ref,{valor:1,actualizado:serverTimestamp()}); return 1;}
    const val=Number(snap.data().valor||0)+1;
    tx.update(ref,{valor:val, actualizado:serverTimestamp()});
    return val;
  });
  return `RV-${String(folio).padStart(6,"0")}`;
}

async function confirmarCobro(){
  if(carrito.length===0){alert("Agrega productos primero"); return;}
  const {subtotal,impuestos,total}=calcularTotales();
  const folio=await getNextFolio();
  const fechaTxt=new Date().toLocaleString();

  // Guardar en Firestore
  const venta={
    folio, rutaId, fecha:serverTimestamp(), fecha_txt:fechaTxt,
    cliente:elCliente.value||"Mostrador",
    atendio:ATENDIO,
    subtotal, impuestos, total,
    detalle:carrito.map(it=>({
      id:it.id,nombre:it.nombre,cantidad:it.cantidad,
      precio_unit:it.precioUnit, importe:it.importe,
      iva_tasa:it.ivaTasa, ieps_tasa:it.iepsTasa
    }))
  };
  await addDoc(collection(db,"rutas_venta",rutaId,"ventas"),venta);

  // Ticket
  document.getElementById("tFolio").textContent="Folio: "+folio;
  document.getElementById("tFecha").textContent=fechaTxt;
  const tLineas=document.getElementById("tLineas");
  tLineas.innerHTML="";
  carrito.forEach(it=>{
    const row=document.createElement("div");
    row.className="t-row";
    row.innerHTML=`<span>${it.cantidad.toFixed(2)} ${it.nombre}</span><span>${money(it.importe)}</span>`;
    tLineas.appendChild(row);
  });
  document.getElementById("tSubtotal").textContent=money(subtotal);
  document.getElementById("tImpuestos").textContent=money(impuestos);
  document.getElementById("tTotal").textContent=money(total);

  window.print();
  carrito=[]; render();
}

/***** Corte del día *****/
async function corteDelDia(){
  const start=new Date(); start.setHours(0,0,0,0);
  const end=new Date(); end.setHours(23,59,59,999);
  const tsStart=Timestamp.fromDate(start), tsEnd=Timestamp.fromDate(end);

  const q=query(
    collection(db,"rutas_venta",rutaId,"ventas"),
    where("fecha",">=",tsStart), where("fecha","<",tsEnd), orderBy("fecha","asc")
  );
  const snap=await getDocs(q);
  if(snap.empty){alert("No hay ventas registradas hoy."); return;}

  let total=0, impuestos=0, subtotal=0;
  snap.forEach(d=>{
    const v=d.data();
    total+=Number(v.total||0);
    impuestos+=Number(v.impuestos||0);
    subtotal+=Number(v.subtotal||0);
  });

  document.getElementById("tFolio").textContent="CORTE DEL DÍA";
  document.getElementById("tFecha").textContent=new Date().toLocaleString();
  const tLineas=document.getElementById("tLineas"); tLineas.innerHTML="";
  document.getElementById("tSubtotal").textContent=money(subtotal);
  document.getElementById("tImpuestos").textContent=money(impuestos);
  document.getElementById("tTotal").textContent=money(total);

  window.print();
}

/***** Botones *****/
document.getElementById("btnCobrar").onclick=confirmarCobro;
document.getElementById("btnCorte").onclick=corteDelDia;

/***** Init *****/
await cargarCatalogo();
render();
</script>
</body>
</html>


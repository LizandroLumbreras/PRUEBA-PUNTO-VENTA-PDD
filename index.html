<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POS – Ruta de Venta</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    /* ===== ESTILOS PRINCIPALES ===== */
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --ok:#1e8e3e; --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9); --muted:rgba(0,0,0,.55); --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px; --radius-sm:10px;
    }
    body{
      margin:0; font-family:'Poppins',system-ui,Arial; background:var(--bg-grad); color:#111;
    }
    header{ background:#0008; color:#fff; text-align:center; padding:10px; font-weight:700; }
    .wrap{ max-width:720px; margin:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }

    .field{ display:flex; gap:6px; align-items:center; }
    .field label{ min-width:70px; font-size:14px; }
    .field input{ flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }

    table{ width:100%; border-collapse:collapse; }
    th,td{ border:1px solid #ddd; padding:6px; font-size:14px; }
    th{ background:var(--azul); color:#fff; }

    .btn{ padding:10px; margin-top:8px; border:none; border-radius:8px; font-weight:700; color:#fff; cursor:pointer; }
    .btn:active{ transform:scale(.98); }
    #btnCobrar{ background:linear-gradient(180deg,var(--resalte),#094d85); }
    #btnCorte{ background:linear-gradient(180deg,#1e8e3e,#146329); }
    #btnReimprimir{ background:linear-gradient(180deg,#6b7280,#374151); }

    /* ===== TICKET PARA IMPRESIÓN ===== */
    #ticketArea{ display:none; }
    @media print{
      body *{ visibility:hidden; }
      #ticketArea,#ticketArea *{ visibility:visible; }
      #ticketArea{ position:fixed; inset:0; margin:auto; }
      .ticket{ font:14px/1.2 'Poppins',sans-serif; }
      .t-row{ display:flex; justify-content:space-between; }
      .t-header{ text-align:center; margin:2px 0; }
    }

    /* ===== MODALES ===== */
    #modalCobro,#modalReimp,#camModal{
      display:none; position:fixed; inset:0; background:#0008; align-items:center; justify-content:center; z-index:2000;
    }
    .modal-card{ background:#fff; border-radius:12px; padding:14px; max-width:520px; width:95%; }
    .modal-h{ font-weight:700; margin-bottom:10px; }
  </style>
</head>
<body>
  <header>POS – Ruta de Venta</header>
  <main class="wrap">
    <div class="field">
      <label>Cliente</label>
      <input id="cliente" list="clientesList" placeholder="Cliente">
      <datalist id="clientesList"></datalist>
    </div>
    <div class="field">
      <label>Buscar</label>
      <input id="buscador" placeholder="Código o nombre">
      <button id="btnCam">📷</button>
    </div>
    <div class="field">
      <label>Cantidad</label>
      <input id="cantidadInput" type="number" value="1" step="0.01">
    </div>

    <table>
      <thead><tr><th>Producto</th><th>Cant</th><th>Importe</th><th></th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div><b>Subtotal:</b> <span id="lblSubtotal">$0.00</span></div>
    <div><b>Impuestos:</b> <span id="lblImpuestos">$0.00</span></div>
    <div><b>Total:</b> <span id="lblTotal">$0.00</span></div>

    <button id="btnCobrar" class="btn">Cobrar</button>
    <button id="btnCorte" class="btn">Corte del día</button>
    <button id="btnReimprimir" class="btn">Reimprimir ticket</button>
  </main>

  <!-- TICKET -->
  <div id="ticketArea">
    <div id="ticket" class="ticket">
      <div class="t-header"><b>La Proveedora</b></div>
      <div class="t-header">Ruta de Venta</div>
      <div class="t-row"><span id="tFolio"></span><span id="tFecha"></span></div>
      <div id="tCliente"></div><hr>
      <div id="tLineas"></div><hr>
      <div class="t-row"><span>Subtotal</span><span id="tSubtotal"></span></div>
      <div class="t-row"><span>Impuestos</span><span id="tImpuestos"></span></div>
      <div class="t-row"><b>Total</b><span id="tTotal"></span></div>
      <div id="tMetodo"></div>
      <div id="tRecibidoRow"></div>
      <div class="t-header">¡Gracias por su compra!</div>
    </div>
  </div>

  <!-- MODAL COBRO -->
  <div id="modalCobro">
    <div class="modal-card">
      <div class="modal-h">Cobro</div>
      <div>Total: <span id="cobroTotal">$0.00</span></div>
      <select id="metodoPago">
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta</option>
        <option value="transferencia">Transferencia</option>
        <option value="mixto">Mixto</option>
      </select>
      <input id="montoRecibido" type="number" placeholder="Monto recibido">
      <div id="montoCambio"></div>
      <textarea id="notasCobro" placeholder="Notas"></textarea>
      <button id="btnConfirmarCobro" class="btn">Confirmar</button>
      <button id="btnCancelarCobro" class="btn" style="background:#999">Cancelar</button>
    </div>
  </div>

  <!-- MODAL REIMPRESION -->
  <div id="modalReimp">
    <div class="modal-card">
      <div class="modal-h">Reimpresión</div>
      <input id="filtroFolio" placeholder="Buscar folio/cliente">
      <input id="filtroFecha" type="date">
      <button id="btnBuscarTickets">Buscar</button>
      <div id="listaTickets" style="max-height:40vh;overflow:auto;"></div>
      <div><button id="btnPrevTickets">◀</button><span id="lblPagina">1</span><button id="btnNextTickets">▶</button></div>
      <button id="btnCerrarReimp">Cerrar</button>
    </div>
  </div>

  <!-- MODAL CÁMARA -->
  <div id="camModal"><div class="modal-card"><div id="camReader"></div><button id="btnCerrarCam">Cerrar</button></div></div>

  <!-- LIBRERÍAS -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, serverTimestamp, runTransaction, doc, getDocs, getDoc, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ===============================
       FIREBASE INIT
    =============================== */
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ===============================
       VARIABLES
    =============================== */
    const $=s=>document.querySelector(s);
    const elCliente=$('#cliente'), elBuscador=$('#buscador'), elCant=$('#cantidadInput');
    const elTbody=$('#tbody'), lblSubtotal=$('#lblSubtotal'), lblImp=$('#lblImpuestos'), lblTotal=$('#lblTotal');
    let carrito=[],prodSeleccionado=null,clienteSeleccionado=null;
    let catalogo=[],clientes=[]; const codeIndex=new Map();
    const rutaId="ruta_1"; const ATENDIO="Juan Serrato";
    const money=n=>'$'+(Number(n)||0).toFixed(2);

    /* ===============================
       CARGA CATÁLOGO Y CLIENTES
    =============================== */
    async function cargarCatalogo(){
      catalogo=[]; codeIndex.clear();
      const snap=await getDocs(collection(db,'productos'));
      snap.forEach(d=>{
        const x=d.data();
        const prod={id:d.id,nombre:x.concepto,codigo:x.codigoBarra,precioPublico:Number(x.precioPublico||0)};
        catalogo.push(prod);
        if(prod.codigo) codeIndex.set(prod.codigo,prod.id);
      });
    }
    async function cargarClientes(){
      clientes=[]; const dl=document.getElementById("clientesList"); dl.innerHTML="";
      const snap=await getDocs(collection(db,'rutas_venta',rutaId,'clientes'));
      snap.forEach(d=>{
        const c=d.data(); const cli={id:d.id,nombre:c.nombre||"",rfc:c.rfc||"",ocupa_factura:c.ocupa_factura||false,uso_cfdi:c.uso_cfdi||""};
        clientes.push(cli); const opt=document.createElement("option"); opt.value=cli.nombre; dl.appendChild(opt);
      });
    }
    elCliente.addEventListener("change",()=>{clienteSeleccionado=clientes.find(c=>c.nombre===elCliente.value)||null;});

    /* ===============================
       CARRITO / RENDER
    =============================== */
    function render(){
      elTbody.innerHTML="";
      carrito.forEach(it=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${it.nombre}</td><td>${it.cantidad}</td><td>${money(it.importe)}</td><td><button>✕</button></td>`;
        tr.querySelector("button").onclick=()=>{carrito=carrito.filter(x=>x.id!==it.id);render();};
        elTbody.appendChild(tr);
      });
      const total=carrito.reduce((s,it)=>s+it.importe,0);
      lblSubtotal.textContent=money(total); lblImp.textContent=money(0); lblTotal.textContent=money(total);
    }
    elCant.addEventListener("keydown",e=>{
      if(e.key==="Enter"&&prodSeleccionado){
        const cant=Number(elCant.value||1);
        carrito.push({...prodSeleccionado,cantidad:cant,importe:cant*prodSeleccionado.precioPublico});
        prodSeleccionado=null;elBuscador.value="";elCant.value=1;render();
      }
    });
    elBuscador.addEventListener("keydown",e=>{
      if(e.key==="Enter"){
        const q=elBuscador.value; const id=codeIndex.get(q);
        if(id){prodSeleccionado=catalogo.find(p=>p.id===id);elBuscador.value=prodSeleccionado.nombre;}
      }
    });

    /* ===============================
       COBRO + GUARDADO VENTA
    =============================== */
    async function getNextFolio(){const ref=doc(db,'consecutivos',rutaId);const f=await runTransaction(db,async tx=>{const s=await tx.get(ref);if(!s.exists()){tx.set(ref,{valor:1});return 1;}const n=s.data().valor+1;tx.update(ref,{valor:n});return n;});return `RV-${String(f).padStart(6,"0")}`;}
    async function guardarVenta(v){const col=collection(db,'rutas_venta',rutaId,'ventas');await addDoc(col,v);}
    function rellenarTicket(v){$('#tFolio').textContent=v.folio;$('#tFecha').textContent=v.fecha_txt;$('#tCliente').textContent="Cliente: "+v.cliente;$('#tLineas').innerHTML=v.detalle.map(it=>`<div class="t-row"><span>${it.cantidad} ${it.nombre}</span><span>${money(it.importe)}</span></div>`).join("");$('#tSubtotal').textContent=money(v.subtotal);$('#tImpuestos').textContent=money(v.impuestos);$('#tTotal').textContent=money(v.total);$('#tMetodo').textContent=v.metodo_pago;}
    async function confirmarCobro(){
      const total=carrito.reduce((s,it)=>s+it.importe,0);
      const folio=await getNextFolio();
      const venta={folio,rutaId,fecha:serverTimestamp(),fecha_txt:new Date().toLocaleString(),cliente:elCliente.value||"Mostrador",atendio:ATENDIO,metodo_pago:$('#metodoPago').value,recibido:Number($('#montoRecibido').value||0),cambio:0,subtotal:total,impuestos:0,total,detalle:carrito};
      await guardarVenta(venta);rellenarTicket(venta);window.print();carrito=[];render();cerrarCobro();
    }
    $('#btnCobrar').onclick=()=>{$('#cobroTotal').textContent=lblTotal.textContent;$('#modalCobro').style.display="flex";}
    $('#btnCancelarCobro').onclick=()=>cerrarCobro();
    $('#btnConfirmarCobro').onclick=confirmarCobro;
    function cerrarCobro(){$('#modalCobro').style.display="none";}

    /* ===============================
       CORTE DEL DÍA + TELEGRAM
    =============================== */
    async function corteDelDia(){
      const hoy=new Date().toISOString().slice(0,10);
      const qv=query(collection(db,'rutas_venta',rutaId,'ventas'),where("fecha_dia","==",hoy));
      const snap=await getDocs(qv);let total=0;let efectivo=0,tarjeta=0,transfer=0,mixto=0;
      snap.forEach(s=>{const v=s.data();total+=v.total;if(v.metodo_pago==="efectivo")efectivo+=v.total;else if(v.metodo_pago==="tarjeta")tarjeta+=v.total;else if(v.metodo_pago==="transferencia")transfer+=v.total;else if(v.metodo_pago==="mixto")mixto+=v.total;});
      alert(`Corte ${hoy}\nTotal:${money(total)}\nEf:${money(efectivo)} Tar:${money(tarjeta)} Tr:${money(transfer)} Mix:${money(mixto)}`);
    }
    $('#btnCorte').onclick=corteDelDia;

    /* ===============================
       REIMPRESIÓN DE TICKETS
    =============================== */
    $('#btnReimprimir').onclick=()=>{$('#modalReimp').style.display="flex";}
    $('#btnCerrarReimp').onclick=()=>{$('#modalReimp').style.display="none";}
    $('#btnBuscarTickets').onclick=buscarTickets;
    async function buscarTickets(){
      const snap=await getDocs(query(collection(db,'rutas_venta',rutaId,'ventas'),orderBy("fecha","desc")));
      $('#listaTickets').innerHTML="";snap.forEach(s=>{const v=s.data();const div=document.createElement("div");div.textContent=`${v.folio} ${v.cliente} ${money(v.total)}`;div.onclick=()=>{rellenarTicket(v);window.print();};$('#listaTickets').appendChild(div);});
    }

    /* ===============================
       INICIO
    =============================== */
    await cargarCatalogo();await cargarClientes();render();
  </script>
</body>
</html>






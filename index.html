<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POS – Ruta de Venta</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --ok:#1e8e3e; --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9); --muted:rgba(0,0,0,.55); --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Arial; color:#111; background:var(--bg-grad);
      display:flex; flex-direction:column; -webkit-font-smoothing:antialiased; -webkit-tap-highlight-color:transparent;
    }

    header{
      position:sticky; top:0; z-index:50;
      background:rgba(0,0,0,.6);
      color:#fff;
      padding:10px 14px;
      display:flex; justify-content:center; align-items:center; gap:8px;
      font-weight:700; font-size:18px;
      backdrop-filter:saturate(120%) blur(4px);
      height:50px;
    }
    header img{ height:75px; object-fit:contain; }

    .wrap{flex:1; padding:12px; display:flex; flex-direction:column; gap:12px; max-width:720px; margin:0 auto}
    .controls{ display:flex; flex-direction:column; gap:10px; }
    .field{
      display:flex; gap:8px; background:rgba(255,255,255,.12); padding:10px; border-radius:var(--radius-sm);
      align-items:center; backdrop-filter:blur(2px);
    }
    .field label{min-width:78px; color:#fff; font-size:13px}
    .field input{ flex:1; padding:10px 12px; border:none; border-radius:8px; font-size:15px; background:#fff; outline:none; }

    .searchbox{ position:relative; z-index:300; }
    .search-results{
      position:absolute; left:90px; right:10px; top:calc(100% + 6px);
      background:#fff; border-radius:12px; box-shadow:var(--shadow);
      max-height:260px; overflow:auto; display:none; z-index:310;
    }
    .result-item{ padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px }
    .result-item small{ color:var(--muted) }
    .result-item:hover{ background:#f2f4f7 }

    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .table-wrap{ max-height:260px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    thead th{ background:var(--azul); color:#fff; padding:10px; font-size:13px; position:sticky; top:0; z-index:100; }
    thead th:nth-child(1){ width:55%; text-align:left; }
    thead th:nth-child(2){ width:15%; text-align:center; }
    thead th:nth-child(3){ width:20%; text-align:right; }
    thead th:nth-child(4){ width:10%; text-align:center; }
    td.del-col{ text-align:center; }
    td.del-col .del{
      background:#e74c3c; color:#fff; border:none; border-radius:50%;
      width:22px; height:22px; font-size:14px; line-height:20px; cursor:pointer;
    }
    td.del-col .del:hover{ background:#c0392b; }

    .totals{ display:flex; flex-direction:column; gap:6px; padding:12px 14px; background:#fff; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:15px }
    .row.muted{ color:var(--muted) }
    .row.big{ font-weight:700; font-size:18px }

    .actions{ padding:6px 0 12px }
    .btn{
      width:100%; border:none; padding:14px; border-radius:12px; font-size:18px; font-weight:700; color:#fff;
      background:linear-gradient(180deg,var(--resalte),#094d85); box-shadow:var(--shadow); cursor:pointer;
    }
    .btn:active{ transform:translateY(1px) }
    #btnCorte{ background:linear-gradient(180deg,#1e8e3e,#146329); margin-top:10px; }

    #modalCobro{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1200; align-items:center; justify-content:center; }
    .modal-card{ width:min(520px,92vw); background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden; }
    .modal-h{ padding:12px 16px; background:#0c6cbd; color:#fff; font-weight:700; }
    .modal-b{ padding:14px 16px; display:flex; flex-direction:column; gap:10px; }
    .modal-b input,.modal-b select{ padding:10px; border-radius:10px; border:1px solid #e1e5ea; }
    body.modal-open{ overflow:hidden; }

    #ticketArea{ display:none; }
    @media print{
      :root{ --ticket-mm:72; --ticket-pad-mm:1; --ticket-font:18px; --line-height:1.08; }
      @page{ size: calc(var(--ticket-mm) * 1mm) auto; margin:0; }
      html,body{ background:#fff!important; height:auto!important; width:calc(var(--ticket-mm) * 1mm); margin:0!important; padding:0!important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      body *{ visibility:hidden!important; }
      #ticketArea, #ticketArea *{ visibility:visible!important; }
      #ticketArea{ position:fixed; inset:0; display:block!important; background:#fff!important; padding:0; margin:0; z-index:99999; }
      #tTipoRow{ display:none !important; }
      .ticket{ width:calc(var(--ticket-mm) * 1mm); margin:0 auto; padding:0 calc(var(--ticket-pad-mm) * 1mm); box-sizing:border-box; font:var(--ticket-font)/var(--line-height) 'Poppins',system-ui,sans-serif; color:#000; text-align:left; overflow:hidden; }
      .ticket .t-header{ text-align:center; margin:2px 0; }
      .ticket img{ display:inline-block; max-width:100%; height:auto; }
      .ticket hr{ border:none; border-top:1px dashed #999; margin:6px 0; }
      .ticket .t-row{ display:flex!important; justify-content:space-between; align-items:center; gap:6px; white-space:nowrap!important; margin:2px 0; }
      .ticket .t-desc{ flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap!important; text-align:left; }
      .ticket .t-imp{ flex:0 0 auto; text-align:right; margin-left:8px; white-space:nowrap!important; }
      .ticket .t-totals{ text-align:right; }
      .ticket .t-totals .row{ display:flex; justify-content:flex-end; gap:10px; }
      .ticket .t-thanks{ text-align:center; margin-top:8px; }
      .ticket .t-strong{ font-size: calc(var(--ticket-font) + 2px); }
      .ticket .t-header img{ max-width:142px!important; }
      .ticket .t-header.biz{ font-size: calc(var(--ticket-font) - 3px); }
      .ticket .t-core,.ticket .t-core *{ font-size: calc(var(--ticket-font) - 3px); }
    }

    /* === LOGO FLOTANTE === */
    #logoFlotante {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
      transition: all 0.4s ease-in-out;
      z-index: 5000;
      pointer-events: none;
    }
    #logoFlotante.mostrar {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>
<body>
  <header>
    <span>POS – Ruta de Venta</span>
    <img src="logo_proveedora.webp" alt="Logo">
  </header>

  <main class="wrap">
    <section class="controls">
      <div class="field">
        <label>Cliente</label>
        <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
        <datalist id="clientesList"></datalist>
      </div>
      <div class="field searchbox">
        <label>Buscar</label>
        <input id="buscador" type="text" placeholder="Escribe o escanea código…">
        <div id="resultados" class="search-results"></div>
      </div>
      <div class="field">
        <label>Cantidad</label>
        <input id="cantidadInput" type="number" step="0.01" min="0.01" value="1">
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Importe</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="totals">
        <div class="row muted"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
        <div class="row muted"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
        <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
      </div>
    </section>

    <section class="actions">
      <button class="btn" id="btnCobrar">Cobrar</button>
      <button class="btn" id="btnCorte">Corte del día</button>
    </section>
  </main>

  <!-- Ticket -->
  <div id="ticketArea">
    <div id="ticket" class="ticket">
      <div class="t-header"><img src="logo_proveedora.webp" alt="Logo"></div>
      <div class="t-header t-strong">La Proveedora</div>
      <div class="t-header t-strong">Ruta de Venta</div>
      <hr>
      <div class="t-header biz">MADERO 690 SUR, CENTRO</div>
      <div class="t-header biz">LINARES, NUEVO LEÓN, 67700</div>
      <div class="t-header biz">RFC: PDD-031204-KL5</div>
      <div class="t-header biz">TEL: (821) 2121805</div>
      <div class="t-header biz">RÉGIMEN GENERAL DE LEY</div>
      <div class="t-header biz">PERSONAS MORALES</div>
      <hr>
      <div class="t-header t-core" id="tFolio"></div>
      <div class="t-header t-core" id="tFecha"></div>
      <div class="t-header t-core">Atendió: <span id="tAtendio"></span></div>
      <hr>
      <div class="t-core" id="tCliente"></div>
      <div class="t-core" id="tTipoRow">Tipo precio: <span id="tTipo"></span></div>
      <hr>
      <div class="t-core" id="tLineas"></div>
      <hr>
      <div class="t-totals t-core">
        <div class="row"><span>Subtotal</span><span id="tSubtotal"></span></div>
        <div class="row"><span>Impuestos</span><span id="tImpuestos"></span></div>
        <div class="row" style="font-weight:700;"><span>Total</span><span id="tTotal"></span></div>
      </div>
      <hr>
      <div class="t-core">Método: <span id="tMetodo"></span></div>
      <div class="t-core" id="tRecibidoRow">Pago: <span id="tRecibido"></span> · Cambio: <span id="tCambio"></span></div>
      <div id="tNotas"></div>
      <div class="t-thanks">¡Gracias por su compra!</div>
    </div>
  </div>

  <!-- LOGO FLOTANTE -->
  <img id="logoFlotante" src="logo_proveedora.webp" alt="Logo Proveedora" width="180">

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, setDoc, serverTimestamp, runTransaction, doc,
           getDocs, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ⚠️ PON AQUÍ TU CONFIGURACIÓN REAL DE FIREBASE
  const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const $=s=>document.querySelector(s);
  const ATENDIO='Juan Serrato',rutaId='ruta_1';
  const money=n=>'$'+(Number(n)||0).toFixed(2);
  const pad2=n=>String(n).padStart(2,'0');
  const toYYYYMMDD=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

  async function calcularResumenDeDia(dateStr){
    const [Y,M,D]=dateStr.split('-').map(Number);
    const start=new Date(Y,M-1,D,0,0,0,0),end=new Date(Y,M-1,D,23,59,59,999);
    const tsStart=Timestamp.fromDate(start),tsEnd=Timestamp.fromDate(end);
    const qv=query(collection(db,'rutas_venta',rutaId,'ventas'),where('fecha','>=',tsStart),where('fecha','<',tsEnd),orderBy('fecha','asc'));
    const snap=await getDocs(qv);
    let total=0,conteo=0;const desg={efectivo:0,tarjeta:0,transferencia:0,mixto:0};
    snap.forEach(s=>{const v=s.data(),t=Number(v.total||0);total+=t;conteo++;const m=(v.metodo_pago||'').toLowerCase();if(m==='efectivo')desg.efectivo+=t;else if(m==='tarjeta')desg.tarjeta+=t;else if(m==='transferencia')desg.transferencia+=t;else if(m==='mixto')desg.mixto+=t;});
    return{total,conteo,desg};
  }

  async function guardarCorteSinImprimir(dateStr){
    const { total, conteo, desg } = await calcularResumenDeDia(dateStr);
    if (conteo === 0) {
      alert('No hay ventas en ' + dateStr);
      return false;
    }
    const corteRef = doc(db, 'rutas_venta', rutaId, 'cortes', dateStr);
    await setDoc(corteRef, {
      fecha_dia: dateStr,
      total,
      tickets: conteo,
      desglose: desg,
      atendio: ATENDIO,
      creado: serverTimestamp()
    });
    return true;
  }

  async function imprimirCorte(dateStr){
    const { total, conteo, desg } = await calcularResumenDeDia(dateStr);
    if (conteo === 0) return;
    const folioCorte=`C-${dateStr.replaceAll('-','')}`,fechaTxt=new Date().toLocaleString();
    $('#tFolio').textContent=`CORTE: ${folioCorte}`;
    $('#tFecha').textContent=fechaTxt;
    $('#tAtendio').textContent=ATENDIO;
    $('#tCliente').textContent=`Ruta: ${rutaId}`;
    $('#tTipo').textContent=`Corte del día ${dateStr}`;
    const tLineas=$('#tLineas');tLineas.innerHTML='';
    const mk=(l,r)=>{const d=document.createElement('div');d.className='t-row';d.innerHTML=`<span class="t-desc">${l}</span><span class="t-imp">${money(r)}</span>`;return d;};
    tLineas.appendChild(mk('EFECTIVO',desg.efectivo));
    tLineas.appendChild(mk('TARJETA',desg.tarjeta));
    tLineas.appendChild(mk('TRANSFER',desg.transferencia));
    tLineas.appendChild(mk('MIXTO',desg.mixto));
    $('#tSubtotal').textContent=money(total);
    $('#tImpuestos').textContent=money(0);
    $('#tTotal').textContent=money(total);
    $('#tMetodo').textContent='—';
    $('#tRecibidoRow').style.display='none';
    $('#tNotas').textContent='Fin de día';
    window.print();
  }

  async function corteDelDia(){
    const seguro=confirm("¿Está seguro de realizar el corte del día?");
    if(!seguro)return;
    const logo=document.getElementById("logoFlotante");
    logo.classList.add("mostrar");
    const hoy=toYYYYMMDD(new Date());
    const guardado=await guardarCorteSinImprimir(hoy);
    setTimeout(async()=>{logo.classList.remove("mostrar");if(guardado)await imprimirCorte(hoy);},5000);
  }

  document.getElementById('btnCorte').onclick=corteDelDia;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS ‚Äì La Proveedora (B√°sico)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --azul:#00416A; --prim:#0c6cbd; --ok:#22aa22; --warn:#b36b00; --bg:#f3f6fb; --card:#ffffff; --sombra:rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(to right,#00416A,#E4E5E6);margin:0;min-height:100vh;color:#111}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;color:#fff;margin-bottom:12px}
    header h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:14px;box-shadow:0 10px 25px var(--sombra);padding:14px;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:2fr 1.3fr;gap:14px}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .brand{font-weight:600;letter-spacing:.3px}
    .tier{display:flex;gap:8px}
    .tier button{border:1px solid #ddd;background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
    .tier button.active{background:#0c6cbd;color:#fff;border-color:#0c6cbd}
    .scan{display:flex;gap:8px}
    input[type="text"], input[type="number"]{width:100%;padding:10px 12px;border:1px solid #d9dee6;border-radius:10px;font-size:14px}
    .btn{background:#0c6cbd;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    #lector{display:none;margin-top:8px}

    .resultados{max-height:52vh;overflow:auto;padding-right:6px}
    .producto{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin:8px 0;display:flex;justify-content:space-between;gap:10px}
    .producto .info{font-size:13px}
    .precios{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .precio-publico{font-weight:600;color:#1a7c1a}
    .precio-medio{color:#004080}
    .precio-mayoreo{color:#b36b00}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef1f5;text-align:center;font-size:13px}
    th{background:#f8fafc}
    .acciones button{border:1px solid #dfe3ea;background:#fff;border-radius:8px;padding:4px 8px;margin:0 2px;cursor:pointer}

    .totales{display:grid;grid-template-columns:1fr;gap:10px}
    .totline{display:flex;justify-content:space-between}
    .totbox{background:#f8fafc;border:1px dashed #cfd6e3;border-radius:12px;padding:10px}
    .paygrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    <div style="margin-top:8px">
  <label style="font-size:12px">M√©todo de pago</label>
  <select id="selMetodo" style="width:100%;padding:10px 12px;border:1px solid #d9dee6;border-radius:10px">
    <option value="efectivo">Efectivo</option>
    <option value="tarjeta">Tarjeta</option>
  </select>
</div>

    /* Ticket print */
    #ticket{display:none}
    @media print{
      body *{visibility:hidden}
      #ticket,#ticket *{visibility:visible}
      #ticket{position:absolute;left:0;top:0;width:250px;font-family:monospace;color:#000}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>POS B√°sico ‚Äì La Proveedora</h1>
      <div class="brand">PROVSOFT</div>
    </header>

    <div class="grid">
      <!-- Columna izquierda: Buscador y resultados -->
      <div class="card">
        <div class="topbar">
          <div class="tier" id="tierBtns">
            <button data-tier="publico" class="active">P√∫blico</button>
            <button data-tier="medio">Medio</button>
            <button data-tier="mayoreo">Mayoreo</button>
          </div>
        </div>
        <div class="scan">
          <input type="text" id="buscador" placeholder="Escribe c√≥digo o nombre‚Ä¶ (Enter para buscar)" />
          <button class="btn" id="btnScan">üì∑ Escanear</button>
        </div>
        <div id="lector"></div>
        <div style="margin-top:6px;font-size:12px;color:#444">
          <progress id="barraProgreso" value="0" max="100" style="width:180px"></progress>
          <span id="estado"></span>
          <span id="contador" style="float:right"></span>
        </div>
        <div id="resultados" class="resultados"></div>
      </div>

      <!-- Columna derecha: Carrito y cobro -->
      <div class="card">
        <h3 style="margin:0 0 8px 0">Carrito</h3>
        <div style="overflow:auto;max-height:36vh">
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Descripci√≥n</th>
                <th>Cant</th>
                <th>Precio</th>
                <th>Importe</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyCarrito"></tbody>
          </table>
        </div>

        <div class="totales" style="margin-top:10px">
          <div class="totbox">
            <div class="totline"><span>Subtotal</span><strong id="lblSubtotal">$0.00</strong></div>
            <div class="totline"><span>IVA (16%)</span><strong id="lblIva">$0.00</strong></div>
            <div class="totline"><span>Total</span><strong id="lblTotal">$0.00</strong></div>
          </div>

          <div class="paygrid">
            <div>
              <label style="font-size:12px">Pago recibido</label>
              <input type="number" id="inpPago" inputmode="decimal" min="0" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <label style="font-size:12px">Cambio</label>
              <input type="text" id="inpCambio" disabled />
            </div>
          </div>

          <button class="btn" id="btnCobrar">üí≥ Cobrar e Imprimir</button>
          <button class="btn" id="btnReimprimir" style="background:#555">üñ®Ô∏è Reimprimir √öltimo Ticket</button>
          <button class="btn" id="btnCorte" style="background:#b36b00">üìä Corte de Caja</button>
          <small id="msgCobro" style="display:block;color:#b00;margin-top:6px"></small>
        </div>
      </div>
    </div>

    <!-- Corte de caja -->
    <div class="card" id="corteBox" style="display:none">
      <h3>Corte de Caja</h3>
      <div id="corteContenido" style="font-size:14px"></div>
    </div>
  </div>
  <!-- Caja: Apertura y Corte -->
<div class="wrap" style="margin-top:10px">
  <div class="card">
    <h3 style="margin:0 0 10px 0">Caja</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;align-items:end">
      <div>
        <label style="font-size:12px">Caja</label>
        <input id="inpCaja" type="text" value="CAJA-1" disabled />
      </div>
      <div>
        <label style="font-size:12px">Monto inicial (apertura)</label>
        <input id="inpMontoInicial" type="number" min="0" step="0.01" placeholder="0.00" />
      </div>
      <div>
        <button class="btn" id="btnApertura">üîì Abrir caja</button>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnCorte" style="background:#b36b00">üßÆ Corte de caja</button>
      <button class="btn" id="btnImprimirCorte" style="background:#555">üñ®Ô∏è Imprimir corte</button>
      <small id="msgCaja" style="color:#b00"></small>
    </div>

    <div id="resumenCorte" style="margin-top:10px;font-size:14px"></div>
  </div>
</div>

  <!-- Ticket para imprimir -->
  <div id="ticket"></div>

  <!-- C√°mara -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, orderBy, doc, runTransaction, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM", authDomain: "inventariopv-643f1.firebaseapp.com", projectId: "inventariopv-643f1", storageBucket: "inventariopv-643f1.firebasestorage.app", messagingSenderId: "96242533231", appId: "1:96242533231:web:aae75a18fbaf9840529e9a" };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    // === Caja ===
    const CAJA_ID = 'CAJA-1';
    const LS_APERTURA = `aperturaActiva_${CAJA_ID}`;
    const state = { tipoPrecio: 'publico', items: [] };
    const tbody=document.getElementById('tbodyCarrito');
    const lblSubtotal=document.getElementById('lblSubtotal');
    const lblIva=document.getElementById('lblIva');
    const lblTotal=document.getElementById('lblTotal');
    const inpPago=document.getElementById('inpPago');
    const inpCambio=document.getElementById('inpCambio');
    const msgCobro=document.getElementById('msgCobro');
    // Caja UI
const inpMontoInicial = document.getElementById('inpMontoInicial');
const btnApertura = document.getElementById('btnApertura');
const btnCorte = document.getElementById('btnCorte');
const btnImprimirCorte = document.getElementById('btnImprimirCorte');
const msgCaja = document.getElementById('msgCaja');
const resumenCorte = document.getElementById('resumenCorte');
const selMetodo = document.getElementById('selMetodo');


    function money(n){return Number(n||0).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});}
    function round2(x){return Math.round((x+Number.EPSILON)*100)/100;}

    function renderCarrito(){
      tbody.innerHTML='';
      state.items.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${it.codigo}</td><td style="text-align:left">${it.desc}</td><td>${it.cant}</td><td>$${money(it.precioUnit)}</td><td>$${money(it.importe)}</td><td><button onclick="state.items.splice(${idx},1);renderCarrito()">Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
      recalcular();
    }

    function recalcular(){
      const subtotal=state.items.reduce((a,i)=>a+i.importe,0);
      const iva=round2(subtotal*0.16);
      const total=round2(subtotal+iva);
      lblSubtotal.textContent=`$${money(subtotal)}`;
      lblIva.textContent=`$${money(iva)}`;
      lblTotal.textContent=`$${money(total)}`;
      const pago=Number(inpPago.value||0);
      inpCambio.value=`$${money(Math.max(0,round2(pago-total)))}`;
    }
    inpPago.addEventListener('input',recalcular);

    document.getElementById('btnCobrar').addEventListener('click', cobrarVenta);
    document.getElementById('btnReimprimir').addEventListener('click', ()=>{if(lastVenta) imprimirTicket(lastVenta);});
    document.getElementById('btnCorte').addEventListener('click', corteCaja);

    let lastVenta=null;
    async function cobrarVenta(){
      const subtotal=state.items.reduce((a,i)=>a+i.importe,0);
      const iva=round2(subtotal*0.16);
      const total=round2(subtotal+iva);
      const pago=Number(inpPago.value||0);
      const metodoPago = selMetodo.value || 'efectivo';
      if(state.items.length===0){msgCobro.textContent='Carrito vac√≠o';return;}
      if(pago<total){msgCobro.textContent='Pago insuficiente';return;}

      const consecutivoRef=doc(db,'consecutivos','ventas');
      const ventaId=crypto.randomUUID();
      const ventaRef=doc(db,'ventas',ventaId);

      await runTransaction(db, async(tx)=>{
        const cons=await tx.get(consecutivoRef);
        const n=(cons.exists()?(cons.data().folioActual||0):0)+1;
        tx.set(consecutivoRef,{folioActual:n});
        const folioStr=`V-${String(n).padStart(6,'0')}`;
const payload = {
  folio: folioStr,
  fecha: serverTimestamp(),
  caja: CAJA_ID,
  metodoPago,
  tipoPrecio: state.tipoPrecio,
  subtotal: round2(subtotal),
  iva,
  total,
  pago,
  cambio: round2(pago-total),
  items: state.items.map(i=>({codigo:i.codigo, descripcion:i.desc, cant:i.cant, precioUnit:i.precioUnit, importe:i.importe}))
};
      const snap=await getDoc(ventaRef); lastVenta=snap.data();
      imprimirTicket(lastVenta);
      state.items=[];renderCarrito();inpPago.value='';recalcular();
    }

    function imprimirTicket(v){
      const el=document.getElementById('ticket');
      const line=t=>`<div style="white-space:pre">${t}</div>`;
      const hdr=['LA PROVEEDORA','BRAVO 244 CENTRO ALLENDE',`FOLIO: ${v.folio}`,`FECHA: ${new Date().toLocaleString('es-MX')}`].map(line).join('');
      const det=(v.items||[]).map(i=>{const desc=(i.descripcion||'').slice(0,20);return line(`${i.cant}x ${desc}`.padEnd(24,' ')+money(i.importe).padStart(8,' '));}).join('');
      const tot=[line('------------------------------'),line(`SUBTOTAL: ${money(v.subtotal)}`),line(`IVA: ${money(v.iva)}`),line(`TOTAL: ${money(v.total)}`),line(`PAGO (${v.metodoPago?.toUpperCase()||''}): ${money(v.pago)}`),line(`CAMBIO: ${money(v.cambio)}`)].join('');
      el.innerHTML=hdr+line('------------------------------')+det+tot+line('¬°GRACIAS!');
      window.print();
    }

    async function corteCaja(){
      const q=query(collection(db,'ventas'), orderBy('fecha','desc'));
      const snap=await getDocs(q);
      let totalVentas=0, totalIva=0, totalSub=0, num=0;
      snap.forEach(d=>{const v=d.data();totalVentas+=v.total||0;totalIva+=v.iva||0;totalSub+=v.subtotal||0;num++;});
      const cont=document.getElementById('corteContenido');
      cont.innerHTML=`<p><b>Ventas registradas:</b> ${num}</p>
      <p><b>Subtotal acumulado:</b> $${money(totalSub)}</p>
      <p><b>IVA acumulado:</b> $${money(totalIva)}</p>
      <p><b>Total vendido:</b> $${money(totalVentas)}</p>`;
      document.getElementById('corteBox').style.display='block';
    }
      // === Apertura de caja ===
btnApertura.addEventListener('click', abrirCaja);
async function abrirCaja(){
  try{
    const monto = Number(inpMontoInicial.value||0);
    if(monto<0){ msgCaja.textContent='Monto inv√°lido'; return; }
    const apRef = doc(db, 'aperturas_caja', crypto.randomUUID());
    await setDoc(apRef, { caja: CAJA_ID, fechaApertura: serverTimestamp(), montoInicial: round2(monto), abierta: true });
    localStorage.setItem(LS_APERTURA, apRef.id);
    msgCaja.textContent = 'Caja abierta';
    btnApertura.disabled = true;
  }catch(e){ msgCaja.textContent='Error al abrir caja'; console.error(e); }
}

// Restaurar estado apertura en carga
(function(){
  const apId = localStorage.getItem(LS_APERTURA);
  if(apId){ btnApertura.disabled = true; }
})();
// === Corte de caja ===
btnCorte.addEventListener('click', corteCaja);
btnImprimirCorte.addEventListener('click', ()=>{
  if(_ultimoCorte) imprimirCorte(_ultimoCorte); else msgCaja.textContent='Primero genera el corte.';
});

let _ultimoCorte=null;
async function corteCaja(){
  msgCaja.textContent='';
  const apId = localStorage.getItem(LS_APERTURA);
  if(!apId){ msgCaja.textContent='No hay apertura activa.'; return; }
  try{
    const apSnap = await getDoc(doc(db,'aperturas_caja', apId));
    if(!apSnap.exists()){ msgCaja.textContent='Apertura no encontrada'; return; }
    const ap = apSnap.data();

    // Ventas desde fechaApertura para esta CAJA
    const qVentas = query(
      collection(db,'ventas'),
      where('caja','==', CAJA_ID),
      where('fecha','>=', ap.fechaApertura)
    );
    const sVentas = await getDocs(qVentas);

    let tickets=0, total=0, efectivo=0, tarjeta=0;
    sVentas.forEach(d=>{
      const v = d.data(); tickets++; total += Number(v.total||0);
      if(v.metodoPago==='efectivo') efectivo += Number(v.total||0); else tarjeta += Number(v.total||0);
    });
    total = round2(total); efectivo = round2(efectivo); tarjeta = round2(tarjeta);
    const montoInicial = Number(ap.montoInicial||0);
    const efectivoTeorico = round2(montoInicial + efectivo);

    const corte = {
      caja: CAJA_ID,
      aperturaId: apId,
      fechaCierre: new Date().toISOString(),
      montoInicial, tickets,
      totalVentas: total, efectivo, tarjeta,
      efectivoTeorico
    };
    _ultimoCorte = corte;

    // Guardar corte y cerrar apertura
    const corteRef = doc(db,'cortes_caja', crypto.randomUUID());
    await setDoc(corteRef, { ...corte, fechaCierreFS: serverTimestamp() });
    await setDoc(doc(db,'aperturas_caja', apId), { ...ap, abierta:false, fechaCierre: serverTimestamp() });
    localStorage.removeItem(LS_APERTURA);
    btnApertura.disabled = false;

    // Mostrar resumen en pantalla
    resumenCorte.innerHTML = `
      <div><b>Caja:</b> ${corte.caja}</div>
      <div><b>Tickets:</b> ${tickets}</div>
      <div><b>Monto inicial:</b> $${money(montoInicial)}</div>
      <div><b>Total ventas:</b> $${money(total)}</div>
      <div><b>Efectivo:</b> $${money(efectivo)}</div>
      <div><b>Tarjeta:</b> $${money(tarjeta)}</div>
      <div><b>Efectivo te√≥rico (f√≠sico esperado):</b> $${money(efectivoTeorico)}</div>
    `;
  }catch(e){ console.error(e); msgCaja.textContent='Error al generar corte.'; }
}

function imprimirCorte(c){
  const el = document.getElementById('ticket');
  const line=t=>`<div style="white-space:pre">${t}</div>`;
  const hdr=['LA PROVEEDORA','CORTE DE CAJA',`CAJA: ${c.caja}`, `FECHA: ${new Date().toLocaleString('es-MX')}`].map(line).join('');
  const det=[
    line('--------------------------------'),
    line(`Tickets:         ${c.tickets}`),
    line(`Monto inicial:   $${money(c.montoInicial)}`),
    line(`Ventas totales:  $${money(c.totalVentas)}`),
    line(`- Efectivo:      $${money(c.efectivo)}`),
    line(`- Tarjeta:       $${money(c.tarjeta)}`),
    line(`EFECTIVO ESP.:   $${money(c.efectivoTeorico)}`)
  ].join('');
  el.innerHTML = hdr + line('--------------------------------') + det + line('Fin de corte');
  window.print();
}
  </script>
</body>
</html>

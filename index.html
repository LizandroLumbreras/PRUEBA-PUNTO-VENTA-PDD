<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POS ‚Äì La Proveedora (Mejorado)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --azul:#00416A; --prim:#0c6cbd; --ok:#22aa22; --warn:#b36b00; --bg:#f3f6fb; --card:#ffffff; --sombra:rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(to right,#00416A,#E4E5E6);margin:0;min-height:100vh;color:#111}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;color:#fff;margin-bottom:12px}
    header h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:14px;box-shadow:0 10px 25px var(--sombra);padding:14px}
    .grid{display:grid;grid-template-columns:2fr 1.3fr;gap:14px}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .brand{font-weight:600;letter-spacing:.3px}
    .tier{display:flex;gap:8px}
    .tier button{border:1px solid #ddd;background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
    .tier button.active{background:#0c6cbd;color:#fff;border-color:#0c6cbd}
    .scan{display:flex;gap:8px}
    input[type="text"], input[type="number"]{width:100%;padding:10px 12px;border:1px solid #d9dee6;border-radius:10px;font-size:14px}
    .btn{background:#0c6cbd;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    #lector{display:none;margin-top:8px}

    .resultados{max-height:52vh;overflow:auto;padding-right:6px}
    .producto{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin:8px 0;display:flex;justify-content:space-between;gap:10px}
    .producto .info{font-size:13px}
    .precios{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .precio-publico{font-weight:600;color:#1a7c1a}
    .precio-medio{color:#004080}
    .precio-mayoreo{color:#b36b00}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef1f5;text-align:center;font-size:13px}
    th{background:#f8fafc}
    .acciones button{border:1px solid #dfe3ea;background:#fff;border-radius:8px;padding:4px 8px;margin:0 2px;cursor:pointer}

    .totales{display:grid;grid-template-columns:1fr;gap:10px}
    .totline{display:flex;justify-content:space-between}
    .totbox{background:#f8fafc;border:1px dashed #cfd6e3;border-radius:12px;padding:10px}
    .paygrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    /* Ticket print */
    #ticket{display:none}
    @media print{
      body *{visibility:hidden}
      #ticket,#ticket *{visibility:visible}
      #ticket{position:absolute;left:0;top:0;width:250px;font-family:monospace;color:#000}
    }

    .row-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    small.hint{color:#444}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>POS ‚Äì La Proveedora</h1>
      <div class="brand">PROVSOFT</div>
    </header>

    <div class="grid">
      <!-- Columna izquierda: Buscador y resultados -->
      <div class="card">
        <div class="topbar">
          <div class="tier" id="tierBtns">
            <button data-tier="publico" class="active">P√∫blico</button>
            <button data-tier="medio">Medio</button>
            <button data-tier="mayoreo">Mayoreo</button>
          </div>
          <small class="hint">Atajos: F2 Buscar ¬∑ F4 Cobrar ¬∑ Ctrl+Del Vaciar</small>
        </div>
        <div class="scan">
          <input type="text" id="buscador" placeholder="Escribe c√≥digo o nombre‚Ä¶ (Enter para buscar)" />
          <button class="btn" id="btnScan">üì∑ Escanear</button>
        </div>
        <div id="lector"></div>
        <div style="margin-top:6px;font-size:12px;color:#444" class="row-actions">
          <div>
            <progress id="barraProgreso" value="0" max="100" style="width:180px"></progress>
            <span id="estado"></span>
          </div>
          <span id="contador" style="margin-left:auto"></span>
        </div>
        <div id="resultados" class="resultados"></div>
      </div>

      <!-- Columna derecha: Carrito y cobro -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <h3 style="margin:0">Carrito</h3>
          <div class="row-actions">
            <button class="btn" id="btnVaciar" style="background:#b03636">üóëÔ∏è Vaciar</button>
          </div>
        </div>
        <div style="overflow:auto;max-height:36vh;margin-top:6px">
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Descripci√≥n</th>
                <th>Cant</th>
                <th>Precio</th>
                <th>Importe</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyCarrito"></tbody>
          </table>
        </div>

        <div class="totales" style="margin-top:10px">
          <div class="totbox" id="boxDescuento">
            <div class="totline" style="gap:10px;align-items:center">
              <span>Descuento global (%)</span>
              <input type="number" id="inpDesc" min="0" max="100" step="0.5" value="0" style="max-width:110px" />
            </div>
          </div>

          <div class="totbox">
            <div class="totline"><span>Subtotal (base sin IVA)</span><strong id="lblSubtotalBase">$0.00</strong></div>
            <div class="totline"><span>IVA (16%)</span><strong id="lblIVA">$0.00</strong></div>
            <div class="totline"><span>Total</span><strong id="lblTotal">$0.00</strong></div>
          </div>

          <div class="paygrid">
            <div>
              <label style="font-size:12px">Pago recibido</label>
              <input type="number" id="inpPago" inputmode="decimal" min="0" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <label style="font-size:12px">Cambio</label>
              <input type="text" id="inpCambio" disabled />
            </div>
          </div>

          <button class="btn" id="btnCobrar">üí≥ Cobrar e Imprimir</button>
          <small id="msgCobro" style="display:block;color:#b00;margin-top:6px"></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Ticket para imprimir -->
  <div id="ticket"></div>

  <!-- C√°mara -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, orderBy, doc, runTransaction, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ======= Config =======
    const IVA = 0.16; // cambia aqu√≠ tu tasa de IVA
    const NOMBRE_NEGOCIO = 'LA PROVEEDORA';
    const DIRECCION_NEGOCIO = 'BRAVO 244 CENTRO ALLENDE';
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ======= Estado POS =======
    const state = {
      tipoPrecio: 'publico',
      items: [],            // {id, codigo, desc, cant, precioUnit, importe, __prod}
      descPorc: 0           // % de descuento global
    };

    // ======= UI refs =======
    const tierBtns = document.getElementById('tierBtns');
    const tbody = document.getElementById('tbodyCarrito');
    const input = document.getElementById('buscador');
    const resultadosDiv = document.getElementById('resultados');
    const barraProgreso = document.getElementById('barraProgreso');
    const estado = document.getElementById('estado');
    const contador = document.getElementById('contador');
    const inpPago = document.getElementById('inpPago');
    const inpCambio = document.getElementById('inpCambio');
    const msgCobro = document.getElementById('msgCobro');
    const lblSubtotalBase = document.getElementById('lblSubtotalBase');
    const lblIVA = document.getElementById('lblIVA');
    const lblTotal = document.getElementById('lblTotal');
    const inpDesc = document.getElementById('inpDesc');

    function money(n){
      const x = Number(n||0);
      return x.toLocaleString('es-MX',{minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function num(v){ const n=Number(v); return isNaN(n)?0:n; }
    function round2(x){ return Math.round((x+Number.EPSILON)*100)/100; }

    // ======= Tiers =======
    tierBtns.addEventListener('click',(e)=>{
      if(e.target.tagName!=='BUTTON') return;
      tierBtns.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      state.tipoPrecio = e.target.dataset.tier;
      // Revalorizar
      state.items.forEach(it=>{
        const prod = it.__prod;
        it.precioUnit = precioPorTier(prod, state.tipoPrecio);
        it.importe = round2(it.precioUnit * it.cant);
      });
      renderCarrito();
    });

    function precioPorTier(p, tier){
      const pub = num(p.precioPublico);
      const med = num(p.medioMayoreo);
      const may = num(p.mayoreo);
      if(tier==='mayoreo') return may || med || pub;
      if(tier==='medio')   return med || pub;
      return pub;
    }

    // ======= Buscador =======
    let resultados = [];
    let pagina = 0;
    const porPagina = 30;

    async function buscarProductos(termino){
      resultadosDiv.innerHTML = "‚è≥ Buscando...";
      barraProgreso.value = 0; estado.textContent = ""; resultados = [];

      // 1) Coincidencia exacta por c√≥digo num√©rico
      if(/^\d+$/.test(termino)){
        const q1 = query(collection(db,'productos'), where('activo','==',true), where('codigoBarra','==', termino));
        const s1 = await getDocs(q1);
        resultados = s1.docs.map(d=>({id:d.id, ...d.data()}));
        // Si hay 1 solo resultado exacto ‚Üí agregar directo al carrito
        if(resultados.length===1){
          agregarAlCarritoDesdeProducto(resultados[0], 1);
          resultadosDiv.innerHTML = '';
          contador.textContent = `Agregado: ${resultados[0].concepto||''}`;
          return;
        }
      }

      // 2) B√∫squeda por concepto cliente-side
      const q2 = query(collection(db,'productos'), where('activo','==',true), orderBy('concepto'));
      const s2 = await getDocs(q2);
      const palabras = termino.toLowerCase().split(/\s+/).filter(Boolean);
      s2.forEach(docu=>{
        const p = {id:docu.id, ...docu.data()};
        const texto = (p.concepto||'').toLowerCase();
        if(palabras.every(w=>texto.includes(w))) resultados.push(p);
      });
      if(resultados.length===0){
        resultadosDiv.innerHTML = '‚ùå No se encontraron resultados'; contador.textContent='';
      } else { mostrarPagina(0); }
    }

    function mostrarPagina(n){
      pagina = n; resultadosDiv.innerHTML = '';
      const inicio = pagina*porPagina, fin = inicio+porPagina;
      const lista = resultados.slice(inicio, fin);

      lista.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'producto';
        const preciosHtml = `
          <div class="precios">
            <span class="precio-publico">P√∫blico: $${p.precioPublico? money(p.precioPublico):'‚Äî'}</span>
            <span class="precio-medio">Medio: $${p.medioMayoreo? money(p.medioMayoreo):'‚Äî'}</span>
            <span class="precio-mayoreo">Mayoreo: $${p.mayoreo? money(p.mayoreo):'‚Äî'}</span>
          </div>`;
        div.innerHTML = `
          <div class="info">
            <b>${p.concepto||'(Sin nombre)'}</b><br>
            <small>C√≥digo: ${p.codigoBarra||'‚Äî'}</small>
            ${preciosHtml}
          </div>
          <div style="display:flex;align-items:center;gap:6px">
            <input type="number" min="1" step="1" value="1" style="width:64px" />
            <button class="btn">+ Agregar</button>
          </div>`;

        const qty = div.querySelector('input');
        const btn = div.querySelector('button');
        btn.addEventListener('click',()=>{
          const cant = Math.max(1, parseInt(qty.value||'1',10));
          agregarAlCarritoDesdeProducto(p, cant);
        });
        resultadosDiv.appendChild(div);
      });

      contador.textContent = `Resultados: ${resultados.length} | P√°gina ${pagina+1} de ${Math.ceil(resultados.length/porPagina)}`;
    }

    let debounceTimer;
    input.addEventListener('input',()=>{
      clearTimeout(debounceTimer);
      const t = input.value.trim();
      if(!t){ resultadosDiv.innerHTML=''; contador.textContent=''; return; }
      debounceTimer = setTimeout(()=>buscarProductos(t), 400);
    });
    input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const t=input.value.trim(); if(t) buscarProductos(t); }});

    // ======= Lector de c√°mara =======
    const divLector = document.getElementById('lector');
    document.getElementById('btnScan').addEventListener('click', iniciarEscaneo);
    function iniciarEscaneo(){
      divLector.style.display='block';
      const lector = new Html5Qrcode('lector');
      lector.start(
        { facingMode: 'environment' },
        { fps: 12, qrbox: 250 },
        async codigo => {
          // al detectar ‚Üí intenta agregar directo
          const q1 = query(collection(db,'productos'), where('activo','==',true), where('codigoBarra','==', codigo));
          const s1 = await getDocs(q1);
          if(s1.size===1){
            const p = {id:s1.docs[0].id, ...s1.docs[0].data()};
            agregarAlCarritoDesdeProducto(p, 1);
            contador.textContent = `Agregado: ${p.concepto||''}`;
          } else {
            input.value = codigo;
            await buscarProductos(codigo);
          }
          // sigue escaneando (no se detiene) para flujo continuo
        },
        err => {/* ruido de escaneo */}
      ).catch(err=>{ console.error('cam error',err); });
    }

    // ======= Carrito =======
    function agregarAlCarritoDesdeProducto(prod, cant){
      const precio = precioPorTier(prod, state.tipoPrecio);
      const existente = state.items.find(x=>x.id===prod.id);
      if(existente){
        existente.cant += cant;
        existente.importe = round2(existente.cant * existente.precioUnit);
      } else {
        state.items.push({
          id: prod.id,
          codigo: prod.codigoBarra||'',
          desc: prod.concepto||'',
          cant: cant,
          precioUnit: precio,
          importe: round2(precio*cant),
          __prod: prod
        });
      }
      renderCarrito();
      saveLocal();
    }

    function renderCarrito(){
      tbody.innerHTML='';
      state.items.forEach((it,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.codigo}</td>
          <td style="text-align:left">${it.desc}</td>
          <td>
            <div style="display:flex;justify-content:center;gap:4px;align-items:center">
              <button data-act="dec" data-i="${idx}">‚àí</button>
              <input type="number" min="1" step="1" value="${it.cant}" style="width:64px" data-i="${idx}"/>
              <button data-act="inc" data-i="${idx}">+</button>
            </div>
          </td>
          <td>$${money(it.precioUnit)}</td>
          <td>$${money(it.importe)}</td>
          <td class="acciones">
            <button data-act="del" data-i="${idx}">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });
      // Delegaci√≥n de botones
      tbody.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const i = Number(e.currentTarget.dataset.i);
          const act = e.currentTarget.dataset.act;
          if(act==='del'){ state.items.splice(i,1); }
          if(act==='inc'){ state.items[i].cant++; state.items[i].importe = round2(state.items[i].cant*state.items[i].precioUnit); }
          if(act==='dec'){ state.items[i].cant = Math.max(1, state.items[i].cant-1); state.items[i].importe = round2(state.items[i].cant*state.items[i].precioUnit); }
          renderCarrito(); saveLocal();
        });
      });
      // Cambios directos en input cantidad
      tbody.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener('change',(e)=>{
          const i = Number(e.currentTarget.dataset.i);
          const v = Math.max(1, parseInt(e.currentTarget.value||'1',10));
          state.items[i].cant = v;
          state.items[i].importe = round2(v*state.items[i].precioUnit);
          renderCarrito(); saveLocal();
        });
      });
      recalcular();
    }

    function totalsBrutos(){
      // Suma importes de l√≠neas (precios ya incluyen IVA)
      return state.items.reduce((a,i)=>a+i.importe,0);
    }

    function recalcular(){
      const bruto = totalsBrutos(); // total con IVA, sin descuento
      const descPorc = Math.min(100, Math.max(0, num(inpDesc.value||0)));
      state.descPorc = descPorc;
      const descuentoImporte = round2(bruto * (descPorc/100));
      const totalDespuesDescuento = Math.max(0, round2(bruto - descuentoImporte));

      // Si los precios incluyen IVA ‚Üí base = total / (1+IVA), iva = total - base
      const base = round2(totalDespuesDescuento / (1+IVA));
      const iva = round2(totalDespuesDescuento - base);

      lblSubtotalBase.textContent = `$${money(base)}`;
      lblIVA.textContent = `$${money(iva)}`;
      lblTotal.textContent = `$${money(totalDespuesDescuento)}`;

      const pago = Number(inpPago.value||0);
      const cambio = Math.max(0, round2(pago - totalDespuesDescuento));
      inpCambio.value = `$${money(cambio)}`;
      msgCobro.textContent = '';
    }

    inpPago.addEventListener('input', recalcular);
    inpDesc.addEventListener('input', recalcular);
    document.getElementById('btnVaciar').addEventListener('click', ()=>{
      state.items = []; renderCarrito(); saveLocal();
    });

    // Persistencia local
    const LSKEY='carritoPOS_v2';
    function saveLocal(){
      localStorage.setItem(LSKEY, JSON.stringify({
        tipoPrecio:state.tipoPrecio, items:state.items, descPorc:state.descPorc
      }));
    }
    function loadLocal(){
      try{
        const raw = JSON.parse(localStorage.getItem(LSKEY)||'null');
        if(raw){
          state.tipoPrecio = raw.tipoPrecio||'publico';
          state.items = (raw.items||[]).map(x=>({...x}));
          state.descPorc = num(raw.descPorc||0);
          inpDesc.value = state.descPorc;
          // activar bot√≥n del tier actual
          tierBtns.querySelectorAll('button').forEach(b=>{
            b.classList.toggle('active', b.dataset.tier===state.tipoPrecio);
          });
          renderCarrito();
        }
      }catch(e){ /* ignore */ }
    }
    loadLocal();

    // ======= Cobro =======
    document.getElementById('btnCobrar').addEventListener('click', cobrarVenta);

    async function cobrarVenta(){
      if(state.items.length===0){ msgCobro.textContent='Carrito vac√≠o'; return; }

      const bruto = totalsBrutos();
      const descuentoImporte = round2(bruto * (state.descPorc/100));
      const total = Math.max(0, round2(bruto - descuentoImporte));
      const base = round2(total / (1+IVA));
      const iva = round2(total - base);

      const pago = Number(inpPago.value||0);
      if(pago < total){ msgCobro.textContent='El pago es menor que el total'; return; }

      const consecutivoRef = doc(db,'consecutivos','ventas');
      const ventaId = crypto.randomUUID();
      const ventaRef = doc(db,'ventas', ventaId);

      let folioStr = '';
      await runTransaction(db, async (tx)=>{
        const consSnap = await tx.get(consecutivoRef);
        const n = (consSnap.exists()? (consSnap.data().folioActual||0):0) + 1;
        tx.set(consecutivoRef,{folioActual:n});
        folioStr = `V-${String(n).padStart(6,'0')}`;
        const payload = {
          folio: folioStr,
          fecha: serverTimestamp(),
          tipoPrecio: state.tipoPrecio,
          subtotalBase: base,
          iva: iva,
          total: total,
          pago: round2(pago),
          cambio: round2(pago-total),
          descuentoPorc: state.descPorc,
          descuentoImporte: descuentoImporte,
          items: state.items.map(i=>({ codigo:i.codigo, descripcion:i.desc, cant:i.cant, precioUnit:i.precioUnit, importe:i.importe }))
        };
        tx.set(ventaRef, payload);
      });

      // Ticket
      const ventaSnap = await getDoc(ventaRef);
      const venta = ventaSnap.data();
      imprimirTicket(venta);

      // limpiar
      state.items=[]; renderCarrito(); saveLocal();
      input.value=''; inpPago.value=''; inpDesc.value = 0; state.descPorc = 0; recalcular();
    }

    // ======= Ticket =======
    function imprimirTicket(venta){
      const el = document.getElementById('ticket');
      const line = (t='') => `<div style="white-space:pre">${t}</div>`;
      const hdr = [
        NOMBRE_NEGOCIO,
        DIRECCION_NEGOCIO,
        `FOLIO: ${venta.folio}`,
        `FECHA: ${new Date().toLocaleString('es-MX')}`
      ].map(line).join('');

      const det = (venta.items||[]).map(i=>{
        const desc = (i.descripcion||'').slice(0,24);
        const izq = `${i.cant}x ${desc}`.padEnd(26,' ');
        const der = money(i.importe).padStart(8,' ');
        return line(izq+der);
      }).join('');

      const tot = [
        line('------------------------------'),
        line(`SUBTOTAL:        ${money(venta.subtotalBase).padStart(10,' ')}`),
        line(`IVA:             ${money(venta.iva).padStart(10,' ')}`),
        (venta.descuentoImporte>0 ? line(`DESC:            ${money(venta.descuentoImporte).padStart(10,' ')}`) : ''),
        line(`TOTAL:           ${money(venta.total).padStart(10,' ')}`),
        line(`PAGO:            ${money(venta.pago).padStart(10,' ')}`),
        line(`CAMBIO:          ${money(venta.cambio).padStart(10,' ')}`)
      ].join('');

      el.innerHTML = hdr + line('------------------------------') + det + tot + line('¬°GRACIAS POR SU COMPRA!');
      window.print();
    }

    // ======= Atajos de teclado =======
    window.addEventListener('keydown', (e)=>{
      // F2 ‚Üí foco en buscador
      if(e.key==='F2'){ e.preventDefault(); input.focus(); input.select(); }
      // F4 ‚Üí cobrar
      if(e.key==='F4'){ e.preventDefault(); document.getElementById('btnCobrar').click(); }
      // Ctrl+Del ‚Üí vaciar
      if(e.key==='Delete' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); document.getElementById('btnVaciar').click(); }
    });
  </script>
</body>
</html>

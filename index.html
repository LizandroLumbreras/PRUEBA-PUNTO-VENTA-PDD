<!DOCTYPE html><html lang="es"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>POS â€“ La Proveedora</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root{--prim:#0c6cbd;--card:#fff;--sombra:rgba(0,0,0,.12)}
*{box-sizing:border-box}body{font-family:Poppins,system-ui,Arial;background:linear-gradient(90deg,#00416A,#E4E5E6);margin:0;color:#111}
.wrap{max-width:1100px;margin:auto;padding:16px}
header{display:flex;align-items:center;justify-content:space-between;color:#fff;margin-bottom:12px}
.card{background:var(--card);border-radius:14px;box-shadow:0 10px 25px var(--sombra);padding:14px}
.grid{display:grid;grid-template-columns:2fr 1.3fr;gap:14px}
.tier{display:flex;gap:8px;margin:6px 0 10px}
.tier button{border:1px solid #ddd;background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
.tier .active{background:var(--prim);color:#fff;border-color:var(--prim)}
.scan{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
input[type=text],input[type=number]{width:100%;padding:10px 12px;border:1px solid #d9dee6;border-radius:10px;font-size:14px}
.btn{background:var(--prim);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.small{font-size:12px;color:#444}
.resultados{max-height:52vh;overflow:auto;padding-right:6px}
.producto{border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin:8px 0;display:flex;justify-content:space-between;gap:10px}
.producto .info{font-size:13px}.precios{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #eef1f5;text-align:center;font-size:13px}th{background:#f8fafc}
.acciones button{border:1px solid #dfe3ea;background:#fff;border-radius:8px;padding:4px 8px;margin:0 2px;cursor:pointer}
.totales{display:grid;gap:10px}.totline{display:flex;justify-content:space-between}
.totbox{background:#f8fafc;border:1px dashed #cfd6e3;border-radius:12px;padding:10px}
#ticket{display:none}@media print{body *{visibility:hidden}#ticket,#ticket *{visibility:visible}#ticket{position:absolute;left:0;top:0;width:250px;font-family:monospace;color:#000}}
</style>
</head><body>
<div class="wrap">
  <header><h1 style="margin:0;font-size:20px">POS BÃ¡sico â€“ La Proveedora</h1><div>PROVSOFT</div></header>

  <div class="grid">
    <!-- IZQ -->
    <div class="card">
      <div class="tier" id="tierBtns">
        <button data-tier="publico" class="active">PÃºblico</button>
        <button data-tier="medio">Medio</button>
        <button data-tier="mayoreo">Mayoreo</button>
      </div>
      <div class="scan">
        <input id="buscador" type="text" placeholder="Escanea o escribe y presiona Enterâ€¦" autofocus/>
        <label class="small" style="display:flex;gap:6px;align-items:center">
          <input id="autoAdd" type="checkbox" checked/> Auto-agregar por cÃ³digo
        </label>
        <button id="btnLimpiar" class="btn" title="Limpiar">Limpiar</button>
      </div>
      <div class="small" style="margin-top:6px">
        <progress id="barraProgreso" value="0" max="100" style="width:160px"></progress>
        <span id="estado"></span><span id="contador" style="float:right"></span>
      </div>
      <div id="resultados" class="resultados"></div>
    </div>

    <!-- DER -->
    <div class="card">
      <h3 style="margin:0 0 8px">Carrito</h3>
      <div style="overflow:auto;max-height:36vh">
        <table><thead><tr>
          <th>CÃ³digo</th><th>DescripciÃ³n</th><th>Cant</th><th>Precio</th><th>Importe</th><th>Acciones</th>
        </tr></thead><tbody id="tbodyCarrito"></tbody></table>
      </div>

      <div class="totales" style="margin-top:10px">
        <div class="totbox">
          <div class="totline"><span>Subtotal</span><strong id="lblSubtotal">$0.00</strong></div>
          <div class="totline"><span>Total</span><strong id="lblTotal">$0.00</strong></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><label class="small">Pago recibido</label><input id="inpPago" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0.00"/></div>
          <div><label class="small">Cambio</label><input id="inpCambio" type="text" disabled/></div>
        </div>
        <button class="btn" id="btnCobrar">ðŸ’³ Cobrar e Imprimir</button>
        <small id="msgCobro" style="display:block;color:#b00;margin-top:6px"></small>
      </div>
    </div>
  </div>
</div>

<div id="ticket"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, runTransaction, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain:"inventariopv-643f1.firebaseapp.com",
  projectId:"inventariopv-643f1",
  storageBucket:"inventariopv-643f1.firebasestorage.app",
  messagingSenderId:"96242533231",
  appId:"1:96242533231:web:aae75a18fbaf9840529e9a"
});
const db = getFirestore(app);

// ---- Estado/UI
const el = s=>document.querySelector(s);
const tierBtns = el('#tierBtns');
const input = el('#buscador');
const autoAdd = el('#autoAdd');
const btnLimpiar = el('#btnLimpiar');
const resultadosDiv = el('#resultados');
const barra = el('#barraProgreso');
const estado = el('#estado');
const contador = el('#contador');
const tbody = el('#tbodyCarrito');
const lblSubtotal = el('#lblSubtotal');
const lblTotal = el('#lblTotal');
const inpPago = el('#inpPago');
const inpCambio = el('#inpCambio');
const msgCobro = el('#msgCobro');

const state = { tipoPrecio:'publico', items:[] };
const LSKEY='carritoPOS';
const money = n => Number(n||0).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});
const num = v => (isNaN(Number(v))?0:Number(v));
const round2 = x => Math.round((Number(x)+Number.EPSILON)*100)/100;

// ---- Tier
tierBtns.addEventListener('click',e=>{
  if(e.target.tagName!=='BUTTON') return;
  tierBtns.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  state.tipoPrecio = e.target.dataset.tier;
  state.items.forEach(it=>{
    it.precioUnit = precioPorTier(it.__prod, state.tipoPrecio);
    it.importe = round2(it.precioUnit*it.cant);
  });
  renderCarrito();
});
function precioPorTier(p,tier){
  const pub=num(p.precioPublico), med=num(p.medioMayoreo), may=num(p.mayoreo);
  if(tier==='mayoreo') return may||med||pub;
  if(tier==='medio') return med||pub;
  return pub;
}

// ---- Buscar
let resultados=[], pagina=0, porPagina=30, debounce;
btnLimpiar.onclick=()=>{ input.value=''; resultados=[]; resultadosDiv.innerHTML=''; contador.textContent=''; estado.textContent=''; barra.value=0; input.focus(); };

async function lookupCodigo(codigo){
  const s = await getDocs(query(collection(db,'productos'), where('activo','==',true), where('codigoBarra','==',codigo)));
  return s.docs.map(d=>({id:d.id,...d.data()}));
}
async function lookupNombre(termino){
  // Trae lote y filtra en cliente (evita Ã­ndices de orderBy)
  const s = await getDocs(query(collection(db,'productos'), where('activo','==',true)));
  const palabras = termino.toLowerCase().split(/\s+/).filter(Boolean);
  const out=[]; s.forEach(docu=>{
    const p={id:docu.id,...docu.data()}, txt=(p.concepto||'').toLowerCase();
    if(palabras.every(w=>txt.includes(w))) out.push(p);
  });
  return out;
}

async function buscar(termino){
  resultadosDiv.innerHTML="â³ Buscandoâ€¦"; estado.textContent=''; barra.value=0; resultados=[];
  // Primero exacto por cÃ³digo si son dÃ­gitos
  if(/^\d{6,}$/.test(termino)){
    resultados = await lookupCodigo(termino);
    if(resultados.length){
      mostrarPagina(0);
      // Auto-agrega directo si estÃ¡ activo y sÃ³lo hay 1
      if(autoAdd.checked && resultados.length===1){
        agregar(resultados[0],1);
        limpiarResultados();
      }
      return;
    }
  }
  // Si no hubo por cÃ³digo, intenta por nombre
  resultados = await lookupNombre(termino);
  if(resultados.length===0){
    resultadosDiv.innerHTML='âŒ No se encontraron resultados'; contador.textContent='';
  }else{
    mostrarPagina(0);
  }
}
function mostrarPagina(n){
  pagina=n; resultadosDiv.innerHTML='';
  const ini=pagina*porPagina, fin=ini+porPagina;
  resultados.slice(ini,fin).forEach(p=>{
    const div=document.createElement('div'); div.className='producto';
    div.innerHTML=`
      <div class="info">
        <b>${p.concepto||'(Sin nombre)'}</b><br>
        <small>CÃ³digo: ${p.codigoBarra||'â€”'}</small>
        <div class="precios">
          <span>PÃºblico: $${p.precioPublico?money(p.precioPublico):'â€”'}</span>
          <span>Medio: $${p.medioMayoreo?money(p.medioMayoreo):'â€”'}</span>
          <span>Mayoreo: $${p.mayoreo?money(p.mayoreo):'â€”'}</span>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <input type="number" min="1" step="1" value="1" style="width:64px"/>
        <button class="btn">+ Agregar</button>
      </div>`;
    const qty=div.querySelector('input'); div.querySelector('button').onclick=()=>agregar(p, Math.max(1,parseInt(qty.value||'1',10)));
    resultadosDiv.appendChild(div);
  });
  contador.textContent=`Resultados: ${resultados.length} | PÃ¡gina ${pagina+1} de ${Math.ceil(resultados.length/porPagina)}`;
}
function limpiarResultados(){ resultados=[]; resultadosDiv.innerHTML=''; contador.textContent=''; estado.textContent=''; barra.value=0; }

// Escucha del lector fÃ­sico:
// - Muchos lectores envÃ­an Enter al final -> procesamos en Enter
// - Si no hay Enter, usamos debounce corto cuando son puros dÃ­gitos (â‰¥6)
input.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const t=input.value.trim(); if(!t) return;
    e.preventDefault(); buscar(t).then(()=>{ input.select(); input.focus(); });
  }
});
input.addEventListener('input',()=>{
  clearTimeout(debounce);
  const t=input.value.trim();
  if(!t){limpiarResultados();return;}
  if(/^\d{6,}$/.test(t)){
    debounce=setTimeout(()=>buscar(t),100); // pequeÃ±o margen para que â€œentre completoâ€
  }else{
    debounce=setTimeout(()=>buscar(t),400);
  }
});

// ---- Carrito
function agregar(prod,cant){
  const precio=precioPorTier(prod,state.tipoPrecio);
  const ex=state.items.find(x=>x.id===prod.id);
  if(ex){ ex.cant+=cant; ex.importe=round2(ex.cant*ex.precioUnit); }
  else{
    state.items.push({id:prod.id,codigo:prod.codigoBarra||'',desc:prod.concepto||'',cant,precioUnit:precio,importe:round2(precio*cant),__prod:prod});
  }
  renderCarrito(); save();
  input.value=''; input.focus();
}
function renderCarrito(){
  tbody.innerHTML='';
  state.items.forEach((it,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${it.codigo}</td>
      <td style="text-align:left">${it.desc}</td>
      <td>
        <div style="display:flex;justify-content:center;gap:4px;align-items:center">
          <button data-act="dec" data-i="${idx}">âˆ’</button>
          <input type="number" min="1" step="1" value="${it.cant}" style="width:64px" data-i="${idx}"/>
          <button data-act="inc" data-i="${idx}">+</button>
        </div>
      </td>
      <td>$${money(it.precioUnit)}</td>
      <td>$${money(it.importe)}</td>
      <td class="acciones"><button data-act="del" data-i="${idx}">Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button').forEach(b=>b.onclick=e=>{
    const i=Number(e.currentTarget.dataset.i), act=e.currentTarget.dataset.act;
    if(act==='del') state.items.splice(i,1);
    if(act==='inc'){state.items[i].cant++; state.items[i].importe=round2(state.items[i].cant*state.items[i].precioUnit);}
    if(act==='dec'){state.items[i].cant=Math.max(1,state.items[i].cant-1); state.items[i].importe=round2(state.items[i].cant*state.items[i].precioUnit);}
    renderCarrito(); save();
  });
  tbody.querySelectorAll('input[type=number]').forEach(n=>n.onchange=e=>{
    const i=Number(e.currentTarget.dataset.i), v=Math.max(1,parseInt(e.currentTarget.value||'1',10));
    state.items[i].cant=v; state.items[i].importe=round2(v*state.items[i].precioUnit);
    renderCarrito(); save();
  });
  recalcular();
}
function recalcular(){
  const subtotal=state.items.reduce((a,i)=>a+i.importe,0);
  lblSubtotal.textContent=`$${money(subtotal)}`;
  lblTotal.textContent=`$${money(subtotal)}`;
  const pago=Number(inpPago.value||0);
  inpCambio.value=`$${money(Math.max(0, round2(pago-subtotal)))}`;
  msgCobro.textContent='';
}
inpPago.oninput=recalcular;

function save(){ localStorage.setItem(LSKEY, JSON.stringify({tipoPrecio:state.tipoPrecio,items:state.items})); }
(function load(){
  try{ const raw=JSON.parse(localStorage.getItem(LSKEY)||'null');
    if(raw){ state.tipoPrecio=raw.tipoPrecio||'publico'; state.items=(raw.items||[]).map(x=>({...x}));
      tierBtns.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.tier===state.tipoPrecio));
      renderCarrito();
    }
  }catch{}
})();

// ---- Cobro
el('#btnCobrar').onclick=cobrar;
async function cobrar(){
  const total=state.items.reduce((a,i)=>a+i.importe,0), pago=Number(inpPago.value||0);
  if(!state.items.length){ msgCobro.textContent='Carrito vacÃ­o'; return; }
  if(pago<total){ msgCobro.textContent='El pago es menor que el total'; return; }

  const consecutivoRef=doc(db,'consecutivos','ventas');
  const ventaId=crypto.randomUUID(); const ventaRef=doc(db,'ventas',ventaId);

  await runTransaction(db, async tx=>{
    const consSnap=await tx.get(consecutivoRef);
    const n=(consSnap.exists()?(consSnap.data().folioActual||0):0)+1;
    tx.set(consecutivoRef,{folioActual:n});
    const folioStr=`V-${String(n).padStart(6,'0')}`;
    tx.set(ventaRef,{
      folio:folioStr, fecha:serverTimestamp(), tipoPrecio:state.tipoPrecio,
      subtotal:round2(total), impuestos:0, total:round2(total),
      pago:round2(pago), cambio:round2(pago-total),
      items:state.items.map(i=>({codigo:i.codigo,descripcion:i.desc,cant:i.cant,precioUnit:i.precioUnit,importe:i.importe}))
    });
  });

  const vSnap=await getDoc(ventaRef); imprimirTicket(vSnap.data());
  state.items=[]; renderCarrito(); save(); input.value=''; inpPago.value=''; recalcular(); input.focus();
}

// ---- Ticket
function imprimirTicket(v){
  const t=el('#ticket');
  const L = s=>`<div style="white-space:pre">${s||''}</div>`;
  const m = x=>Number(x||0).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});
  const hdr=[ 'LA PROVEEDORA','BRAVO 244 CENTRO ALLENDE',`FOLIO: ${v.folio}`,`FECHA: ${new Date().toLocaleString('es-MX')}` ].map(L).join('');
  const det=(v.items||[]).map(i=>{ const d=(i.descripcion||'').slice(0,24); const izq=`${i.cant}x ${d}`.padEnd(26,' '); const der=m(i.importe).padStart(8,' '); return L(izq+der);}).join('');
  const tot=[ L('------------------------------'), L(`TOTAL:            ${m(v.total).padStart(10,' ')}`), L(`PAGO:             ${m(v.pago).padStart(10,' ')}`), L(`CAMBIO:           ${m(v.cambio).padStart(10,' ')}`) ].join('');
  t.innerHTML = hdr+L('------------------------------')+det+tot+L('Â¡GRACIAS!'); window.print();
}
</script>
</body>
</html>

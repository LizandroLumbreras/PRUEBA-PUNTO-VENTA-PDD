<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POS â€“ Ruta de Venta</title>
  <link rel="icon" href="data:,">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --ok:#1e8e3e; --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9); --muted:rgba(0,0,0,.55); --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Arial; color:#111; background:var(--bg-grad);
      display:flex; flex-direction:column; -webkit-font-smoothing:antialiased; -webkit-tap-highlight-color:transparent;
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(0,0,0,.6);
      color:#fff;
      padding:10px 14px;
      display:flex; justify-content:center; align-items:center; gap:8px;
      font-weight:700; font-size:18px;
      backdrop-filter:saturate(120%) blur(4px);
      height:50px;
    }
    header img{ height:28px; object-fit:contain; }

    /* Layout */
    .wrap{flex:1; padding:12px; display:flex; flex-direction:column; gap:12px; max-width:720px; margin:0 auto}
    .controls{ display:flex; flex-direction:column; gap:10px; }
    .field{
      display:flex; gap:8px; background:rgba(255,255,255,.12); padding:10px; border-radius:var(--radius-sm);
      align-items:center; backdrop-filter:blur(2px);
    }
    .field label{min-width:78px; color:#fff; font-size:13px}
    .field input{ flex:1; padding:10px 12px; border:none; border-radius:8px; font-size:15px; background:#fff; outline:none; }

    /* Buscador */
    .searchbox{ position:relative; z-index:300; }
    .search-results{
      position:absolute; left:90px; right:10px; top:calc(100% + 6px);
      background:#fff; border-radius:12px; box-shadow:var(--shadow);
      max-height:260px; overflow:auto; display:none; z-index:310;
    }
    .result-item{ padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px }
    .result-item small{ color:var(--muted) }
    .result-item:hover{ background:#f2f4f7 }

    /* Tabla carrito */
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .table-wrap{ max-height:260px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    thead th{ background:var(--azul); color:#fff; padding:10px; font-size:13px; position:sticky; top:0; z-index:100; }
    thead th:nth-child(1){ width:55%; text-align:left; }
    thead th:nth-child(2){ width:15%; text-align:center; }
    thead th:nth-child(3){ width:20%; text-align:right; }
    thead th:nth-child(4){ width:10%; text-align:center; }
    td.del-col{ text-align:center; }
    td.del-col .del{
      background:#e74c3c; color:#fff; border:none; border-radius:50%;
      width:22px; height:22px; font-size:14px; line-height:20px; cursor:pointer;
    }
    td.del-col .del:hover{ background:#c0392b; }

    /* Totales */
    .totals{ display:flex; flex-direction:column; gap:6px; padding:12px 14px; background:#fff; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:15px }
    .row.muted{ color:var(--muted) }
    .row.big{ font-weight:700; font-size:18px }

    /* Botones */
    .actions{ padding:6px 0 12px }
    .btn{
      width:100%; border:none; padding:14px; border-radius:12px; font-size:18px; font-weight:700; color:#fff;
      background:linear-gradient(180deg,var(--resalte),#094d85); box-shadow:var(--shadow); cursor:pointer;
    }
    .btn:active{ transform:translateY(1px) }
    #btnCorte{ background:linear-gradient(180deg,#1e8e3e,#146329); margin-top:10px; }

    /* CÃ¡mara */
    .cam-btn{
      position:absolute; right:14px; top:50%; transform:translateY(-50%);
      border:none; padding:8px 10px; border-radius:10px; cursor:pointer;
      background:#0c6cbd; color:#fff; font-size:16px;
    }
    .cam-btn:active{ transform:translateY(-49%); }
    /* ===== Modal Cobro ===== */
#modalCobro {
  display: none; /* oculto por defecto */
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 1400;
  align-items: center;
  justify-content: center;
}

#modalCobro .modal-card {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
  width: min(420px, 95vw);
  max-height: 90vh;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#modalCobro .modal-h {
  font-weight: 700;
  font-size: 18px;
  margin-bottom: 10px;
}

#modalCobro .modal-b label {
  font-size: 14px;
  font-weight: 600;
  margin-top: 6px;
  display: block;
}

#modalCobro .modal-b input,
#modalCobro .modal-b select,
#modalCobro .modal-b textarea {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 15px;
  margin-bottom: 8px;
}
    /* Ticket solo visible en impresiÃ³n */
#ticketArea {
  display: none;
}

@media print {
  body * {
    visibility: hidden;
  }
  #ticketArea, #ticketArea * {
    visibility: visible;
  }
  #ticketArea {
    display: block;
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }
}
  </style>
</head>

<body>
  <header>
    <span>POS â€“ Ruta de Venta</span>
    <img src="logo_proveedora.webp" alt="Logo">
  </header>

  <main class="wrap">
    <!-- Cliente -->
    <section class="controls">
      <div class="field">
        <label>Cliente</label>
        <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
        <datalist id="clientesList"></datalist>
      </div>

      <!-- Buscador -->
      <div class="field searchbox">
        <label>Buscar</label>
        <input id="buscador" type="text" placeholder="Escribe o escanea cÃ³digoâ€¦">
        <button id="btnCam" class="cam-btn" type="button">ðŸ“·</button>
        <div id="resultados" class="search-results"></div>
      </div>

      <!-- Cantidad -->
      <div class="field">
        <label>Cantidad</label>
        <input id="cantidadInput" type="number" step="0.01" min="0.01" value="1">
      </div>
    </section>

    <!-- Carrito -->
    <section class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Importe</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="totals">
        <div class="row muted"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
        <div class="row muted"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
        <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
      </div>
    </section>

    <!-- Botones -->
    <section class="actions">
      <button class="btn" id="btnCobrar">Cobrar</button>
      <button class="btn" id="btnCorte">Corte del dÃ­a</button>
      <button class="btn" id="btnReimprimir" style="margin-top:10px; background:linear-gradient(180deg,#6b7280,#374151);">
        ðŸ§¾ Reimprimir ticket
      </button>
    </section>
  </main>


  <!-- Modal de Cobro -->
  <div id="modalCobro">
    <div class="modal-card">
      <div class="modal-h">Cobro</div>
      <div class="modal-b">
        <div class="row big" style="justify-content:space-between">
          <span>Total a pagar:</span>
          <span id="cobroTotal">$0.00</span>
        </div>

        <label for="metodoPago">MÃ©todo de pago</label>
        <select id="metodoPago">
          <option value="efectivo">Efectivo</option>
          <option value="tarjeta">Tarjeta</option>
          <option value="transferencia">Transferencia</option>
          <option value="mixto">Mixto</option>
        </select>

        <div id="bloqueEfectivo">
          <label for="montoRecibido">Monto recibido</label>
          <input id="montoRecibido" type="number" step="0.01" min="0">
          <div class="row" style="justify-content:space-between">
            <span>Cambio:</span>
            <span id="montoCambio">$0.00</span>
          </div>
        </div>

        <label for="notasCobro">Notas</label>
        <textarea id="notasCobro" rows="2" style="resize:none"></textarea>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn" id="btnCancelarCobro" style="background:#aaa;">Cancelar</button>
          <button class="btn" id="btnConfirmarCobro">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal ReimpresiÃ³n de Tickets -->
  <div id="modalReimp" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1300; align-items:center; justify-content:center;">
    <div class="modal-card" style="width:min(720px,96vw); background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden;">
      <div class="modal-h" style="display:flex; align-items:center; justify-content:space-between;">
        <span>Reimprimir tickets</span>
        <button id="btnCerrarReimp" class="btn" style="background:#aaa; width:auto; padding:8px 12px; font-size:14px;">Cerrar</button>
      </div>
      <div class="modal-b" style="padding:14px 16px; display:flex; flex-direction:column; gap:10px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <input id="filtroFolio" type="text" placeholder="Buscar por folio o cliente..." style="flex:1; padding:10px; border-radius:10px; border:1px solid #e1e5ea;">
          <input id="filtroFecha" type="date" style="padding:10px; border-radius:10px; border:1px solid #e1e5ea;">
          <button id="btnBuscarTickets" class="btn" style="width:auto; padding:10px 12px; font-size:14px;">Buscar</button>
        </div>

        <div id="listaTickets" style="max-height:50vh; overflow:auto; border:1px solid #e5e7eb; border-radius:12px;"></div>

        <div style="display:flex; gap:8px; justify-content:flex-end; align-items:center;">
          <button id="btnPrevTickets" class="btn" style="width:auto; padding:8px 10px; font-size:14px; background:#64748b;">â—€</button>
          <span id="lblPagina" style="min-width:70px; text-align:center;">1</span>
          <button id="btnNextTickets" class="btn" style="width:auto; padding:8px 10px; font-size:14px; background:#64748b;">â–¶</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal CÃ¡mara -->
  <div id="camModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1500; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; padding:12px; width:min(420px,90vw)">
      <div style="display:flex; gap:8px; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong>Escanear cÃ³digo</strong>
        <div style="display:flex; gap:6px;">
          <button id="btnTorch" class="btn" style="display:none; width:auto; padding:6px 10px; font-size:14px; background:#0c6cbd;">Linterna</button>
          <button id="btnAF"    class="btn" style="display:none; width:auto; padding:6px 10px; font-size:14px; background:#0c6cbd;">Auto-focus</button>
        </div>
      </div>
      <div id="camReader" style="width:100%"></div>
      <button id="btnCerrarCam" class="btn" style="margin-top:8px; background:#aaa; width:100%;">Cerrar</button>
    </div>
  </div>

  <!-- Ticket imprimible -->
  <div id="ticketArea">
    <div id="ticket" class="ticket">
      <div class="t-header"><img src="logo_proveedora.webp" alt="Logo"></div>
      <div class="t-header t-strong">La Proveedora</div>
      <div class="t-header t-strong">Ruta de Venta</div>
      <hr>
      <div class="t-header biz">MADERO 690 SUR, CENTRO</div>
      <div class="t-header biz">LINARES, NUEVO LEÃ“N, 67700</div>
      <div class="t-header biz">RFC: PDD-031204-KL5</div>
      <div class="t-header biz">TEL: (821) 2121805</div>
      <div class="t-header biz">RÃ‰GIMEN GENERAL DE LEY</div>
      <div class="t-header biz">PERSONAS MORALES</div>
      <hr>
      <div class="t-header t-core" id="tFolio"></div>
      <div class="t-header t-core" id="tFecha"></div>
      <div class="t-header t-core">AtendiÃ³: <span id="tAtendio"></span></div>
      <hr>
      <div class="t-core" id="tCliente"></div>
      <div class="t-core" id="tTipoRow">Tipo precio: <span id="tTipo"></span></div>

      <!-- FacturaciÃ³n -->
      <div class="t-core" id="tFacturaRow">Factura: <span id="tFacturaVal"></span></div>
      <div class="t-core" id="tRFCRow" style="display:none;">RFC: <span id="tRFC"></span></div>
      <div class="t-core" id="tCFDIRow" style="display:none;">Uso CFDI: <span id="tCFDI"></span></div>

      <hr>
      <div class="t-core" id="tLineas"></div>
      <hr>
      <div class="t-totals t-core">
        <div class="row"><span>Subtotal</span><span id="tSubtotal"></span></div>
        <div class="row"><span>Impuestos</span><span id="tImpuestos"></span></div>
        <div class="row" style="font-weight:700;"><span>Total</span><span id="tTotal"></span></div>
      </div>
      <hr>
      <div class="t-core">MÃ©todo: <span id="tMetodo"></span></div>
      <div class="t-core" id="tRecibidoRow">Pago: <span id="tRecibido"></span> Â· Cambio: <span id="tCambio"></span></div>
      <div id="tNotas"></div>
      <div class="t-thanks">Â¡Gracias por su compra!</div>
    </div>
  </div>

  <!-- LibrerÃ­a de escÃ¡ner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <!-- JavaScript Principal -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, setDoc, serverTimestamp, runTransaction, doc,
      getDocs, getDoc, query, where, orderBy, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ================================
       IndexedDB (ventas offline / cache)
    ================================= */
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("pos_ruta", 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains("ventas_pendientes")) {
            db.createObjectStore("ventas_pendientes", { keyPath: "folio" });
          }
          if (!db.objectStoreNames.contains("cache_catalogo")) {
            db.createObjectStore("cache_catalogo", { keyPath: "id" });
          }
          if (!db.objectStoreNames.contains("cache_clientes")) {
            db.createObjectStore("cache_clientes", { keyPath: "id" });
          }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    async function guardarVentaOffline(venta) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction("ventas_pendientes", "readwrite");
        tx.objectStore("ventas_pendientes").put(venta);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }
    async function getVentasPendientes() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction("ventas_pendientes", "readonly");
        const req = tx.objectStore("ventas_pendientes").getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }
    async function borrarVentaPendiente(folio) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction("ventas_pendientes", "readwrite");
        tx.objectStore("ventas_pendientes").delete(folio);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    /* ================================
       Firebase Config
    ================================= */
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ================================
       Helpers & Variables Globales
    ================================= */
    const $ = (s)=>document.querySelector(s);
    const elCliente=$('#cliente'), elBuscador=$('#buscador'), elCant=$('#cantidadInput');
    const elResultados=$('#resultados'), elTbody=$('#tbody');
    const lblSubtotal=$('#lblSubtotal'), lblTotal=$('#lblTotal'), lblImp=$('#lblImpuestos');

    const ATENDIO='Juan Serrato', rutaId='ruta_1';
    const money=(n)=>'$'+(Number(n)||0).toFixed(2);
    const pad2=n=>String(n).padStart(2,'0');
    const toYYYYMMDD=(date)=>{const d=new Date(date); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;};
    const normaliza=s=>(s||'').toString().trim().toLowerCase();

    let carrito=[], prodSeleccionado=null, clienteSeleccionado=null;
    let catalogo=[], clientes=[]; const codeIndex=new Map();

    async function obtenerUbicacion(){
      return new Promise((resolve) => {
        if (!navigator.geolocation) { resolve(null); return; }
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          (_err) => resolve(null),
          { enableHighAccuracy: true, timeout: 5000 }
        );
      });
    }

    /* ================================
       CÃ¡mara / EscÃ¡ner
    ================================= */
    const btnCam       = document.getElementById('btnCam');
    const camModal     = document.getElementById('camModal');
    const camReaderDiv = document.getElementById('camReader');
    const btnCerrarCam = document.getElementById('btnCerrarCam');
    const btnTorch     = document.getElementById('btnTorch');
    const btnAF        = document.getElementById('btnAF');

    let lector = null;
    let _videoTrack = null;
    let _torchOn = false;

    async function abrirCam(){
      document.body.classList.add('modal-open');
      camModal.style.display = 'flex';
      if (lector) { try{ await lector.stop(); }catch{} }
      lector = new Html5Qrcode('camReader');

      const vw = Math.min(window.innerWidth, 480);
      const qrW = Math.floor(vw * 0.9);
      const qrH = Math.floor(qrW * 0.55);

      const onScanSuccess = async (codigo) => {
        try{ await lector.stop(); }catch{}
        lector = null; _videoTrack = null; _torchOn = false;
        camModal.style.display = 'none';
        document.body.classList.remove('modal-open');

        elBuscador.value = (codigo || '').trim();
        const hits = buscarLocal(elBuscador.value);
        if (hits.length >= 1) {
          prodSeleccionado = hits[0];
          elResultados.style.display = "none";
          elBuscador.value = hits[0].nombre;
          elCant.focus(); elCant.select();
        } else {
          pintarResultados(buscarLocal(elBuscador.value));
          elBuscador.focus();
        }
      };

      try{
        await lector.start(
          { facingMode: { ideal: "environment" } },
          { fps: 24, qrbox: { width: qrW, height: qrH }, aspectRatio: 1.7778,
            formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.CODE_128 ] },
          onScanSuccess
        );
        const vid = camReaderDiv.querySelector('video');
        _videoTrack = vid?.srcObject?.getVideoTracks?.()[0] || null;
        const caps = _videoTrack?.getCapabilities?.() || {};
        if (caps.torch)  btnTorch.style.display = 'inline-flex';
        if (caps.focusMode?.includes('continuous') || caps.focusMode?.includes('auto'))
          btnAF.style.display = 'inline-flex';
      }catch(e){
        alert('No se pudo abrir la cÃ¡mara');
        camModal.style.display = 'none';
        document.body.classList.remove('modal-open');
      }
    }
    function cerrarCam(){
      if (lector) { lector.stop().catch(()=>{}); lector = null; }
      if (_videoTrack) { try{ _videoTrack.stop(); }catch{} _videoTrack = null; }
      _torchOn = false;
      camModal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }
    btnCam.addEventListener('click', abrirCam);
    btnCerrarCam.addEventListener('click', cerrarCam);
    camModal.addEventListener('click', (e)=>{ if(e.target === camModal) cerrarCam(); });

    /* ================================
       CatÃ¡logo y Clientes
    ================================= */
    async function cargarCatalogoDesdeFirestore(){
      catalogo=[]; codeIndex.clear();
      const prodSnap=await getDocs(collection(db,'productos'));
      prodSnap.forEach(d=>{
        const x=d.data(); if(x.activo===false)return;
        const prod={id:d.id, nombre:x.concepto||'SIN NOMBRE',
          codigo:(x.codigoBarra||'').toString(),
          precioPublico:Number(x.precioPublico||0),
          ivaTasa:Number(x.ivaTasa||0),
          iepsTasa:Number(x.iepsTasa||0)};
        catalogo.push(prod);
        if(prod.codigo) codeIndex.set(prod.codigo.trim(),prod.id);
      });
    }
    async function cargarClientes(){
      clientes=[]; const dl=document.getElementById("clientesList"); dl.innerHTML="";
      const snap=await getDocs(collection(db,"clientes"));
      snap.forEach(d=>{
        const c=d.data()||{}; if(c.activo===false)return;
        const cli={id:d.id,nombre:c.nombre||"",alias:c.alias||"",telefono:c.telefono||"",ciudad:c.ciudad||"",
          rfc:c.rfc||"",ocupa_factura:!!c.ocupa_factura,uso_cfdi:c.uso_cfdi||""};
        clientes.push(cli);
        const opt=document.createElement("option");
        opt.value=cli.nombre; opt.label=cli.alias?`${cli.nombre} (${cli.alias})`:cli.nombre; dl.appendChild(opt);
      });
    }
    elCliente.addEventListener("change", ()=>{ const v=normaliza(elCliente.value);
      clienteSeleccionado=clientes.find(c=>normaliza(c.nombre)===v)||null; });

    /* ================================
       Carrito y Totales
    ================================= */
    const priceOf=(p)=>Number(p.precioPublico||0);
    function calcularTotalesConImpuestosIncluidos(){
      let total=0, impuestos=0;
      carrito.forEach(it=>{
        const imp=it.cantidad*it.precioUnit;
        total+=imp;
        if(it.ivaTasa>0)  impuestos+=(imp*it.ivaTasa)/(1+it.ivaTasa);
        if(it.iepsTasa>0) impuestos+=(imp*it.iepsTasa)/(1+it.iepsTasa);
      });
      const subtotal=total-impuestos;
      return {subtotal:+subtotal.toFixed(2),impuestos:+impuestos.toFixed(2),total:+total.toFixed(2)};
    }
    function render(){
      elTbody.innerHTML="";
      carrito.forEach(it=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${it.nombre}</td><td>${it.cantidad.toFixed(2)}</td><td>${money(it.importe)}</td>
          <td class="del-col"><button class="del">âœ•</button></td>`;
        tr.querySelector('.del').onclick=()=>delItem(it.id);
        elTbody.appendChild(tr);
      });
      const {subtotal,impuestos,total}=calcularTotalesConImpuestosIncluidos();
      lblSubtotal.textContent=money(subtotal); lblImp.textContent=money(impuestos); lblTotal.textContent=money(total);
    }
    function delItem(id){ carrito=carrito.filter(x=>x.id!==id); render(); }
    function addProduct(prod,cantidad=1){
      if(!prod)return; const cant=Math.max(0.01,Number(cantidad)||1); const precio=priceOf(prod);
      const ex=carrito.find(x=>x.id===prod.id);
      if(ex){ex.cantidad+=cant; ex.importe=ex.cantidad*precio;}
      else{carrito.push({...prod,cantidad:cant,precioUnit:precio,importe:cant*precio});}
      render();
    }

    /* ================================
       Buscador y CÃ³digos de Balanza
    ================================= */
    function detectarCodigoPeso(codigoStr){
      if(/^\d{13}$/.test(codigoStr) && codigoStr.startsWith("20")){
        const base = codigoStr.substring(0,7);
        const pesoNum = parseInt(codigoStr.substring(7,12),10);
        return {base, pesoKg: pesoNum/1000};
      }
      return null;
    }
    function buscarLocal(qraw){
      const q=(qraw||"").trim(); if(!q)return[];
      const det=detectarCodigoPeso(q);
      if(det){const idByCode=codeIndex.get(det.base); if(idByCode){const prod=catalogo.find(x=>x.id===idByCode); if(prod)return[{...prod,cantidadBalanza:det.pesoKg}];}}
      const idByCode=codeIndex.get(q); if(idByCode){const p=catalogo.find(x=>x.id===idByCode); if(p)return[p];}
      const nq=normaliza(q); return catalogo.filter(p=>normaliza(p.nombre).includes(nq));
    }
    function pintarResultados(hits){
      elResultados.innerHTML=""; if(hits.length===0){elResultados.style.display="none";return;}
      elResultados.style.display="block";
      hits.forEach(p=>{
        const div=document.createElement("div");
        div.className="result-item";
        div.innerHTML=`<span>${p.nombre}</span><span><small>${p.codigo}</small> ${money(priceOf(p))}</span>`;
        div.onclick=()=>{prodSeleccionado=p; elBuscador.value=p.nombre; elResultados.style.display="none"; elCant.focus(); elCant.select();};
        elResultados.appendChild(div);
      });
    }
    elBuscador.addEventListener('input',()=>pintarResultados(buscarLocal(elBuscador.value)));
    elBuscador.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){const hits=buscarLocal(elBuscador.value.trim());
      if(hits.length>=1){prodSeleccionado=hits[0];elResultados.style.display="none";elBuscador.value=hits[0].nombre;elCant.focus();elCant.select();}}});
    elCant.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ if(!clienteSeleccionado){alert('Selecciona un cliente primero.');elCliente.focus();return;}
      if(!prodSeleccionado){alert('Selecciona un producto.');elBuscador.focus();return;}
      let cant=prodSeleccionado.cantidadBalanza?prodSeleccionado.cantidadBalanza:parseFloat(elCant.value||'');
      if(isNaN(cant)||cant<=0){alert('Ingresa cantidad vÃ¡lida.');elCant.focus();return;}
      addProduct(prodSeleccionado,cant); prodSeleccionado=null; elBuscador.value=''; elCant.value='1'; elBuscador.focus(); }});

    /* ================================
       Cobro y Guardado de Ventas
    ================================= */
    const modalCobro=$('#modalCobro'); const cobroTotal=$('#cobroTotal');
    const metodoPago=$('#metodoPago'); const bloqueEfectivo=$('#bloqueEfectivo');
    const montoRecibido=$('#montoRecibido'); const montoCambio=$('#montoCambio'); const notasCobro=$('#notasCobro');
    function abrirCobro(){ if(carrito.length===0){alert('Agrega productos primero');return;}
      document.body.classList.add('modal-open'); const {total}=calcularTotalesConImpuestosIncluidos();
      cobroTotal.textContent=money(total); montoRecibido.value=''; montoCambio.textContent=money(0);
      notasCobro.value=''; metodoPago.value='efectivo'; bloqueEfectivo.style.display='block'; modalCobro.style.display='flex';}
    function cerrarCobro(){modalCobro.style.display='none'; document.body.classList.remove('modal-open');}
    metodoPago.addEventListener('change',()=>{const isCash=metodoPago.value==='efectivo'||metodoPago.value==='mixto'; bloqueEfectivo.style.display=isCash?'block':'none';});
    montoRecibido.addEventListener('input',()=>{const {total}=calcularTotalesConImpuestosIncluidos(); const recibidoX=parseFloat(montoRecibido.value||'0'); montoCambio.textContent=money(Math.max(0,recibidoX-total));});
    async function getNextFolio(db){ const ref=doc(db,'consecutivos',rutaId); return await runTransaction(db,async(tx)=>{const snap=await tx.get(ref);
      if(!snap.exists()){tx.set(ref,{valor:1,actualizado:serverTimestamp()}); return "RV-000001";}
      const actual=Number(snap.data().valor||0)+1; tx.update(ref,{valor:actual,actualizado:serverTimestamp()}); return `RV-${String(actual).padStart(6,'0')}`;});}
    async function guardarVentaEnFirestore(payload){const col=collection(db,'rutas_venta',rutaId,'ventas'); const docRef=await addDoc(col,payload); return docRef.id;}

    async function confirmarCobro(){ try{ const {subtotal,impuestos,total}=calcularTotalesConImpuestosIncluidos();
      const clienteTxt=elCliente.value||'Mostrador'; const metodo=metodoPago.value; const recibido=parseFloat(montoRecibido.value||'0');
      if((metodo==='efectivo'||metodo==='mixto')&&recibido<total){ alert('Pago insuficiente'); return; }
      const cambio=Math.max(0,recibido-total); const notas=(notasCobro.value||'').trim();
      const folio=await getNextFolio(db); const fecha=new Date(); const fechaTxt=fecha.toLocaleString(); const fecha_dia=toYYYYMMDD(fecha);
      const ubicacion = await obtenerUbicacion();
      const venta={folio,rutaId,fecha:serverTimestamp(),fecha_txt:fechaTxt,fecha_dia,cliente:clienteTxt,cliente_id: clienteSeleccionado?.id || null,
        atendio:ATENDIO,tipo_precio:"publico",metodo_pago:metodo,recibido:(metodo==='efectivo'||metodo==='mixto')?recibido:0,
        cambio:(metodo==='efectivo'||metodo==='mixto')?cambio:0,subtotal,impuestos,total,notas,productos:carrito.map(p=>({id:p.id,nombre:p.nombre,cantidad:p.cantidad,precio:p.precioUnit,importe:p.importe})),ubicacion};
      try{await guardarVentaEnFirestore(venta); await enviarTelegram(venta); await borrarVentaPendiente(venta.folio);}
      catch(err){console.warn("Error Firestore, guardo offline",err); await guardarVentaOffline(venta);}
      imprimirTicket(venta); carrito=[]; render(); cerrarCobro(); }
      catch(e){alert("Error en cobro: "+e.message);} }
    $('#btnCobrar').addEventListener('click',abrirCobro); $('#btnCancelarCobro').addEventListener('click',cerrarCobro); $('#btnConfirmarCobro').addEventListener('click',confirmarCobro);

    /* ================================
       Corte del DÃ­a
    ================================= */
    async function calcularCorteDelDia(){const hoy=toYYYYMMDD(new Date()); const ventasRef=collection(db,'rutas_venta',rutaId,'ventas');
      const q=query(ventasRef,where("fecha_dia","==",hoy)); const snap=await getDocs(q); let total=0,efectivo=0,tarjeta=0,transfer=0;
      snap.forEach(doc=>{const v=doc.data(); total+=v.total||0; if(v.metodo_pago==='efectivo')efectivo+=v.total||0;
        else if(v.metodo_pago==='tarjeta')tarjeta+=v.total||0; else if(v.metodo_pago==='transferencia')transfer+=v.total||0;});
      return {total,efectivo,tarjeta,transfer}; }
    async function mostrarCorte(){const r=await calcularCorteDelDia(); alert(`Corte de Hoy:\n\nTotal: ${money(r.total)}\nEfectivo: ${money(r.efectivo)}\nTarjeta: ${money(r.tarjeta)}\nTransferencia: ${money(r.transfer)}`);}
    $('#btnCorte').addEventListener('click',mostrarCorte);

    /* ================================
       ReimpresiÃ³n de Tickets
    ================================= */
    const modalReimp=$('#modalReimp'); const listaTickets=$('#listaTickets'); const lblPagina=$('#lblPagina');
    let pagina=1; const tamPagina=10; let cacheTickets=[];
    function abrirReimp(){modalReimp.style.display='flex'; document.body.classList.add('modal-open'); buscarTickets();}
    function cerrarReimp(){modalReimp.style.display='none'; document.body.classList.remove('modal-open');}
    $('#btnReimprimir').addEventListener('click',abrirReimp); $('#btnCerrarReimp').addEventListener('click',cerrarReimp);
    $('#btnPrevTickets').addEventListener('click',()=>{if(pagina>1){pagina--; renderTickets();}}); $('#btnNextTickets').addEventListener('click',()=>{if(pagina*tamPagina<cacheTickets.length){pagina++; renderTickets();}});
    $('#btnBuscarTickets').addEventListener('click',()=>buscarTickets());
    async function buscarTickets(){const filtroFolio=document.getElementById('filtroFolio').value.toLowerCase(); const filtroFecha=document.getElementById('filtroFecha').value;
      const col=collection(db,'rutas_venta',rutaId,'ventas'); let qv=query(col,orderBy("fecha","desc")); const snap=await getDocs(qv);
      cacheTickets=[]; snap.forEach(d=>{const v=d.data(); v.id=d.id; if(filtroFolio && !(v.folio?.toLowerCase().includes(filtroFolio)|| (v.cliente||'').toLowerCase().includes(filtroFolio)))return;
        if(filtroFecha && v.fecha_dia!==filtroFecha)return; cacheTickets.push(v);}); pagina=1; renderTickets();}
    function renderTickets(){listaTickets.innerHTML=''; const ini=(pagina-1)*tamPagina; const fin=ini+tamPagina; const subset=cacheTickets.slice(ini,fin);
      subset.forEach(v=>{const div=document.createElement('div'); div.style.padding='8px 10px'; div.style.borderBottom='1px solid #ddd';
        div.style.cursor='pointer'; div.textContent=`${v.folio} - ${v.fecha_txt} - ${v.cliente} - ${money(v.total)}`;
        div.onclick=()=>imprimirTicket(v); listaTickets.appendChild(div);}); lblPagina.textContent=pagina;}
    
    /* ================================
       Ticket de Venta
    ================================= */
    function imprimirTicket(venta){ const t=document.getElementById('ticket');
      t.querySelector('#tFolio').textContent='Folio: '+venta.folio; t.querySelector('#tFecha').textContent=venta.fecha_txt;
      t.querySelector('#tAtendio').textContent=venta.atendio||ATENDIO; t.querySelector('#tCliente').textContent=venta.cliente||'Mostrador';
      t.querySelector('#tTipo').textContent=venta.tipo_precio||'publico';
      const factRow=document.getElementById('tFacturaRow'); factRow.style.display=venta.cliente_id && clienteSeleccionado?.ocupa_factura?'block':'none';
      document.getElementById('tRFCRow').style.display=venta.cliente_id && clienteSeleccionado?.ocupa_factura?'block':'none';
      document.getElementById('tCFDIRow').style.display=venta.cliente_id && clienteSeleccionado?.ocupa_factura?'block':'none';
      const tLineas=document.getElementById('tLineas'); tLineas.innerHTML=''; (venta.productos||[]).forEach(p=>{const div=document.createElement('div'); div.className='t-row';
        div.innerHTML=`<span class="t-desc">${p.cantidad.toFixed(2)} x ${p.nombre}</span><span class="t-imp">${money(p.importe)}</span>`; tLineas.appendChild(div);});
      document.getElementById('tSubtotal').textContent=money(venta.subtotal); document.getElementById('tImpuestos').textContent=money(venta.impuestos); document.getElementById('tTotal').textContent=money(venta.total);
      document.getElementById('tMetodo').textContent=venta.metodo_pago; document.getElementById('tRecibido').textContent=money(venta.recibido||0); document.getElementById('tCambio').textContent=money(venta.cambio||0);
      document.getElementById('tNotas').textContent=venta.notas||''; window.print(); }

    /* ================================
       Telegram
    ================================= */
    async function enviarTelegram(venta){ try{ const token="8272633411:AAE6uKTpEtPW--IPk6ufix_CDGJ0dH6ru4Q"; const chatId="6617988297";
      const txt=`ðŸ§¾ *Nueva venta* ${venta.folio}\nCliente: ${venta.cliente}\nTotal: ${money(venta.total)}\nMÃ©todo: ${venta.metodo_pago}`;
      await fetch(`https://api.telegram.org/bot${token}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:chatId,text:txt,parse_mode:"Markdown"})}); }
      catch(e){ console.warn("Error enviando a Telegram",e); } }

    /* ================================
       InicializaciÃ³n
    ================================= */
    (async ()=>{ try{ await cargarCatalogoDesdeFirestore(); await cargarClientes(); render(); }catch(err){ console.error("Error en inicializaciÃ³n:",err); }})();
  </script>
</body>
</html>


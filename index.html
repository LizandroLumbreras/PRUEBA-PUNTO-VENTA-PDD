<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POS – Ruta de Venta</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --ok:#1e8e3e; --bg-grad:linear-gradient(to right,#00416A,#E4E5E6);
      --card: rgba(255,255,255,.9); --muted:rgba(0,0,0,.55); --shadow:0 6px 18px rgba(0,0,0,.18);
      --radius:14px; --radius-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Arial; color:#111; background:var(--bg-grad);
      display:flex; flex-direction:column; -webkit-font-smoothing:antialiased; -webkit-tap-highlight-color:transparent;
    }

    header{
      position:sticky; top:0; z-index:50;
      background:rgba(0,0,0,.6); color:#fff; padding:10px 14px;
      display:flex; justify-content:center; align-items:center; gap:8px;
      font-weight:700; font-size:18px; backdrop-filter:saturate(120%) blur(4px);
    }
    header img{ height:34px; filter:drop-shadow(0 0 2px rgba(0,0,0,.4)); }

    .wrap{flex:1; padding:12px; display:flex; flex-direction:column; gap:12px; max-width:720px; margin:0 auto}

    .controls{ display:flex; flex-direction:column; gap:10px; }
    .field{
      display:flex; gap:8px; background:rgba(255,255,255,.12); padding:10px; border-radius:var(--radius-sm);
      align-items:center; backdrop-filter:blur(2px);
    }
    .field label{min-width:78px; color:#fff; font-size:13px}
    .field input{ flex:1; padding:10px 12px; border:none; border-radius:8px; font-size:15px; background:#fff; outline:none; }

    /* Buscador */
    .searchbox{ position:relative; z-index:300; }
    .search-results{
      position:absolute; left:90px; right:10px; top:calc(100% + 6px);
      background:#fff; border-radius:12px; box-shadow:var(--shadow);
      max-height:260px; overflow:auto; display:none; z-index:310;
    }
    .result-item{ padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px }
    .result-item small{ color:var(--muted) }
    .result-item:hover{ background:#f2f4f7 }

    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }

    /* Tabla */
    .table-wrap{ max-height:260px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    thead th{ background:var(--azul); color:#fff; padding:10px; font-size:13px; position:sticky; top:0; z-index:100; }
    thead th:nth-child(1){ width:55%; text-align:left; }
    thead th:nth-child(2){ width:15%; text-align:center; }
    thead th:nth-child(3){ width:20%; text-align:right; }
    thead th:nth-child(4){ width:10%; text-align:center; }
    td.del-col{ text-align:center; }
    td.del-col .del{
      background:#e74c3c;
      color:#fff;
      border:none;
      border-radius:50%;
      width:22px;
      height:22px;
      font-size:14px;
      line-height:20px;
      cursor:pointer;
    }
    td.del-col .del:hover{ background:#c0392b; }

    .qty{ display:inline-flex; align-items:center; gap:8px; background:#f6f8fb; border-radius:999px; padding:4px 8px; }
    .qty button{
      width:26px; height:26px; border:none; border-radius:999px; cursor:pointer; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.12);
      font-size:16px; line-height:26px;
    }

    .totals{ display:flex; flex-direction:column; gap:6px; padding:12px 14px; background:#fff; }
    .row{ display:flex; justify-content:space-between; align-items:center; font-size:15px }
    .row.muted{ color:var(--muted) }
    .row.big{ font-weight:700; font-size:18px }

    .actions{ padding:6px 0 12px }
    .btn{
      width:100%; border:none; padding:14px; border-radius:12px; font-size:18px; font-weight:700; color:#fff;
      background:linear-gradient(180deg,var(--resalte),#094d85); box-shadow:var(--shadow); cursor:pointer;
    }
    .btn:active{ transform:translateY(1px) }
    #btnCorte{ background:linear-gradient(180deg,#1e8e3e,#146329); margin-top:10px; }

    /* Modal Cobro */
    #modalCobro{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1200; align-items:center; justify-content:center; }
    .modal-card{ width:min(520px,92vw); background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden; }
    .modal-h{ padding:12px 16px; background:#0c6cbd; color:#fff; font-weight:700; }
    .modal-b{ padding:14px 16px; display:flex; flex-direction:column; gap:10px; }
    .modal-b input,.modal-b select{ padding:10px; border-radius:10px; border:1px solid #e1e5ea; }
    body.modal-open{ overflow:hidden; }

    /* ===== IMPRESIÓN DEL TICKET ===== */
    #ticketArea{ display:none; }

    @media print{
      @page{ size: 58mm auto; margin: 0; }
      html, body{ background:#fff!important; height:auto!important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      body *{ visibility:hidden!important; }
      #ticketArea, #ticketArea *{ visibility:visible!important; }
      #ticketArea{
        position:fixed; inset:0;
        display:block!important;
        background:#fff!important;
        padding:0; margin:0;
        z-index:99999;
      }
      .ticket{
        width:58mm;
        margin:0;
        padding:0 2mm;
        box-sizing:border-box;
        font:13px/1.25 'Poppins',system-ui,sans-serif;
        color:#000;
        overflow:hidden;
        text-align:left;
      }
      .ticket .t-header{ text-align:center; margin:2px 0; }
      .ticket img{ display:inline-block; max-width:140px; height:auto; }
      .ticket hr{ border:none; border-top:1px dashed #999; margin:6px 0; }
      .ticket .t-row{
        display:flex!important; justify-content:space-between;
        align-items:center; gap:6px; white-space:nowrap!important; margin:2px 0;
      }
      .ticket .t-desc{ flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap!important; text-align:left; }
      .ticket .t-imp{ flex:0 0 auto; text-align:right; white-space:nowrap!important; margin-left:8px; }
      .ticket .t-totals{ text-align:right; }
      .ticket .t-totals .row{ display:flex; justify-content:flex-end; gap:10px; }
      .ticket .t-totals .value{ min-width:58px; text-align:right; }
      .ticket .t-thanks{ text-align:center; margin-top:8px; }
    }
  </style>
</head>
<body>
  <header>
    <span>POS – Ruta de Venta</span>
    <img src="logo_proveedora.webp" alt="Logo">
  </header>

  <main class="wrap">
    <section class="controls">
      <div class="field">
        <label>Cliente</label>
        <input id="cliente" list="clientesList" type="text" placeholder="Nombre del cliente"/>
        <datalist id="clientesList"></datalist>
      </div>
      <div class="field searchbox">
        <label>Buscar</label>
        <input id="buscador" type="text" placeholder="Escribe o escanea código…">
        <div id="resultados" class="search-results"></div>
      </div>
      <div class="field">
        <label>Cantidad</label>
        <input id="cantidadInput" type="number" step="0.01" min="0.01" value="1">
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Importe</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="totals">
        <div class="row muted"><span>Subtotal</span><span id="lblSubtotal">$0.00</span></div>
        <div class="row muted"><span>Impuestos</span><span id="lblImpuestos">$0.00</span></div>
        <div class="row big"><span>Total</span><span id="lblTotal">$0.00</span></div>
      </div>
    </section>

    <section class="actions">
      <button class="btn" id="btnCobrar">Cobrar</button>
      <button class="btn" id="btnCorte">Corte del día</button>
    </section>
  </main>

  <!-- Ticket imprimible -->
  <div id="ticketArea">
    <div id="ticket" class="ticket">
      <div class="t-header"><img src="logo_proveedora.webp" alt="Logo" style="max-width:140px;"></div>
      <div class="t-header t-strong">La Proveedora</div>
      <div class="t-header">Ruta de Venta</div>
      <hr>
      <div class="t-header">MADERO 690 SUR, CENTRO</div>
      <div class="t-header">LINARES, NUEVO LEÓN, 67700</div>
      <div class="t-header">RFC: PDD-031204-KL5</div>
      <div class="t-header">TEL: (821) 2121805</div>
      <div class="t-header">RÉGIMEN GENERAL DE LEY</div>
      <div class="t-header">PERSONAS MORALES</div>
      <hr>
      <div class="t-header" id="tFolio"></div>
      <div class="t-header" id="tFecha"></div>
      <div class="t-header">Atendió: <span id="tAtendio"></span></div>
      <hr>
      <div id="tCliente"></div>
      <div>Tipo precio: <span id="tTipo"></span></div>
      <hr>
      <div id="tLineas"></div>
      <hr>
      <div class="t-totals">
        <div class="row"><span>Subtotal</span><span id="tSubtotal"></span></div>
        <div class="row"><span>Impuestos</span><span id="tImpuestos"></span></div>
        <div class="row" style="font-weight:700;"><span>Total</span><span id="tTotal"></span></div>
      </div>
      <hr>
      <div>Método: <span id="tMetodo"></span></div>
      <div id="tRecibidoRow">Pago: <span id="tRecibido"></span> · Cambio: <span id="tCambio"></span></div>
      <div id="tNotas"></div>
      <div class="t-thanks">¡Gracias por su compra!</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, runTransaction, doc,
             getDocs, query, where, orderBy, Timestamp } 
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { /* tus credenciales */ };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = (s)=>document.querySelector(s);
    const elCliente = $('#cliente'), elBuscador = $('#buscador'), elCant = $('#cantidadInput');
    const elResultados = $('#resultados'), elTbody = $('#tbody');
    const lblSubtotal = $('#lblSubtotal'), lblTotal = $('#lblTotal'), lblImp = $('#lblImpuestos');

    const ATENDIO  = 'Juan Serrato';
    const rutaId   = 'ruta_1';
    const money = (n)=>'$'+(Number(n)||0).toFixed(2);

    let carrito = [];
    let prodSeleccionado = null;

    let catalogo = [];
    const codeIndex = new Map();
    const normaliza = s => (s||'').toString().trim().toLowerCase();

    async function cargarCatalogoDesdeFirestore(){
      catalogo = []; codeIndex.clear();
      const prodSnap = await getDocs(collection(db, 'productos'));
      prodSnap.forEach(d=>{
        const x = d.data();
        if (x.activo === false) return;
        const prod = {
          id: d.id,
          nombre: x.concepto || 'SIN NOMBRE',
          codigo: (x.codigoBarra||'').toString(),
          precioPublico: Number(x.precioPublico || 0),
          ivaTasa: Number(x.ivaTasa || 0),
          iepsTasa: Number(x.iepsTasa || 0),
        };
        catalogo.push(prod);
        if(prod.codigo) codeIndex.set(prod.codigo.trim(), prod.id);
      });
    }

    // Totales con impuestos incluidos
    function calcularTotalesConImpuestosIncluidos(){
      let total = 0, impuestos = 0;
      carrito.forEach(it=>{
        const importe = it.cantidad * it.precioUnit;
        total += importe;
        if(it.ivaTasa>0){ impuestos += (importe*it.ivaTasa)/(1+it.ivaTasa); }
        if(it.iepsTasa>0){ impuestos += (importe*it.iepsTasa)/(1+it.iepsTasa); }
      });
      const subtotal = total - impuestos;
      return {subtotal:+subtotal.toFixed(2), impuestos:+impuestos.toFixed(2), total:+total.toFixed(2)};
    }

    function render(){
      elTbody.innerHTML = '';
      carrito.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="prod">${it.nombre}</td>
          <td class="cant">
            <div class="qty">
              <button type="button" class="menos">−</button>
              <span>${Number(it.cantidad).toFixed(2)}</span>
              <button type="button" class="mas">+</button>
            </div>
          </td>
          <td class="imp">${money(it.importe)}</td>
          <td class="del-col"><button type="button" class="del">✕</button></td>
        `;
        tr.querySelector('.menos').onclick = ()=> setCantidad(it.id, it.cantidad - 0.01);
        tr.querySelector('.mas').onclick   = ()=> setCantidad(it.id, it.cantidad + 0.01);
        tr.querySelector('.del').onclick   = ()=> delItem(it.id);
        elTbody.appendChild(tr);
      });
      const {subtotal, impuestos, total} = calcularTotalesConImpuestosIncluidos();
      lblSubtotal.textContent = money(subtotal);
      lblImp.textContent = money(impuestos);
      lblTotal.textContent = money(total);
    }

    function addProduct(prod, cantidad=1){
      if(!prod) return;
      const cant = Math.max(0.01, Number(cantidad)||1);
      const precio = Number(prod.precioPublico||0);
      const ex = carrito.find(x=>x.id===prod.id);
      if(ex){ ex.cantidad+=cant; ex.importe=ex.cantidad*precio; }
      else{ carrito.push({...prod, cantidad:cant, precioUnit:precio, importe:cant*precio}); }
      render();
    }
    function setCantidad(id,nueva){ const it=carrito.find(x=>x.id===id); if(!it) return;
      it.cantidad=Math.max(0.01,Number(nueva)||it.cantidad); it.importe=it.cantidad*it.precioUnit; render();}
    function delItem(id){carrito=carrito.filter(x=>x.id!==id); render();}

    // Ticket
    function rellenarTicket({folio, fechaTxt, clienteTxt, metodo, recibido, cambio, notas}){
      document.getElementById('tFolio').textContent = `Folio: ${folio}`;
      document.getElementById('tFecha').textContent = fechaTxt;
      document.getElementById('tAtendio').textContent = ATENDIO;
      document.getElementById('tCliente').textContent = `Cliente: ${clienteTxt}`;
      document.getElementById('tTipo').textContent = "Público";
      const tLineas = document.getElementById('tLineas'); tLineas.innerHTML='';
      carrito.forEach(it=>{
        const fila=document.createElement('div'); fila.className='t-row';
        const desc=document.createElement('span'); desc.className='t-desc'; desc.textContent=`${it.cantidad.toFixed(2)} ${it.nombre}`;
        const imp=document.createElement('span'); imp.className='t-imp'; imp.textContent=money(it.importe);
        fila.appendChild(desc); fila.appendChild(imp); tLineas.appendChild(fila);
      });
      const {subtotal, impuestos, total} = calcularTotalesConImpuestosIncluidos();
      document.getElementById('tSubtotal').textContent=money(subtotal);
      document.getElementById('tImpuestos').textContent=money(impuestos);
      document.getElementById('tTotal').textContent=money(total);
    }
    /***** Buscador *****/
    function buscarLocal(qraw){
      const q = (qraw||'').trim();
      if(!q) return [];
      // match por código exacto
      const idByCode = codeIndex.get(q);
      if(idByCode){ const p=catalogo.find(x=>x.id===idByCode); if(p) return [p]; }
      // por nombre
      const nq = normaliza(q);
      const porNombre = catalogo.filter(p => normaliza(p.nombre).includes(nq));
      if(porNombre.length) return porNombre.slice(0,40);
      // por fragmento de código
      if(/^[A-Za-z0-9\-]{3,}$/.test(q)){
        const porCod = catalogo.filter(p=>{
          const cod = (p.codigo||'').toString();
          if(cod.includes(q)) return true;
          return (p.equivalentes||[]).some(eq => (eq||'').toString().includes(q));
        });
        if(porCod.length) return porCod.slice(0,40);
      }
      return [];
    }
    function seleccionarProducto(p){
      prodSeleccionado = p;
      elResultados.style.display='none';
      elCant.value='1';
      elCant.focus(); elCant.select();
    }
    function pintarResultados(hits){
      elResultados.innerHTML=''; if(hits.length===0){ elResultados.style.display='none'; return; }
      elResultados.style.display='block';
      hits.forEach(p=>{
        const div = document.createElement('div');
        div.className='result-item';
        div.innerHTML = `<span>${p.nombre}</span><span><small>${p.codigo||''}</small> ${money(priceOf(p))}</span>`;
        div.onclick = ()=> seleccionarProducto(p);
        elResultados.appendChild(div);
      });
    }
    elBuscador.addEventListener('input', ()=> pintarResultados(buscarLocal(elBuscador.value)));
    elBuscador.addEventListener('keydown', (ev)=>{
      if(ev.key==='Enter'){
        const hits = buscarLocal(elBuscador.value);
        if(hits.length===1) seleccionarProducto(hits[0]);
      }
    });
    elCant.addEventListener('keydown', (ev)=>{
      if(ev.key==='Enter' && prodSeleccionado){
        addProduct(prodSeleccionado, parseFloat(elCant.value||'1'));
        prodSeleccionado = null;
        elCant.value='1'; elBuscador.value=''; elBuscador.focus();
      }
    });
    document.addEventListener('click', (e)=>{ if(!e.target.closest('.searchbox')) elResultados.style.display='none'; });

    /***** Cobro + Firestore *****/
    const modalCobro = document.getElementById('modalCobro');
    const cobroTotal = document.getElementById('cobroTotal');
    const metodoPago = document.getElementById('metodoPago');
    const bloqueEfectivo = document.getElementById('bloqueEfectivo');
    const montoRecibido = document.getElementById('montoRecibido');
    const montoCambio = document.getElementById('montoCambio');
    const notasCobro = document.getElementById('notasCobro');

    function abrirCobro(){
      if(carrito.length===0){ alert('Agrega productos primero'); return; }
      elResultados.style.display='none';
      document.body.classList.add('modal-open');
      const { total } = calcularTotalesIncluyendoIVA();
      cobroTotal.textContent = money(total);
      montoRecibido.value=''; montoCambio.textContent=money(0);
      notasCobro.value=''; metodoPago.value='efectivo'; bloqueEfectivo.style.display='block';
      modalCobro.style.display='flex';
      setTimeout(()=>montoRecibido.focus(), 50);
    }
    function cerrarCobro(){ modalCobro.style.display='none'; document.body.classList.remove('modal-open'); }
    metodoPago.addEventListener('change', ()=>{
      const isCash = metodoPago.value==='efectivo' || metodoPago.value==='mixto';
      bloqueEfectivo.style.display = isCash ? 'block' : 'none';
    });
    montoRecibido.addEventListener('input', ()=>{
      const { total } = calcularTotalesIncluyendoIVA();
      const recibido = parseFloat(montoRecibido.value||'0');
      const cambio = Math.max(0, recibido - total);
      montoCambio.textContent = money(cambio);
    });

    async function getNextFolio(db){
      const ref = doc(db, 'consecutivos', rutaId);
      const folio = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()){ tx.set(ref,{valor:1,actualizado:serverTimestamp()}); return 1; }
        const actual = Number(snap.data().valor||0)+1;
        tx.update(ref,{valor:actual, actualizado:serverTimestamp()});
        return actual;
      });
      return `RV-${String(folio).padStart(6,'0')}`;
    }
    async function guardarVentaEnFirestore(payload){
      const col = collection(db, 'rutas_venta', rutaId, 'ventas');
      const docRef = await addDoc(col, payload);
      return docRef.id;
    }

    // Rellena ticket (usa las clases y el CSS de impresión)
function rellenarTicket({folio, fechaTxt, clienteTxt, metodo, recibido, cambio, notas}){
  document.getElementById('tFolio').textContent = `Folio: ${folio}`;
  document.getElementById('tFecha').textContent = fechaTxt;
  document.getElementById('tAtendio').textContent = ATENDIO;

  const partes = [];
  partes.push(`Cliente: ${clienteTxt}`);
  if(clienteSeleccionado){
    if(clienteSeleccionado.telefono) partes.push(`Tel: ${clienteSeleccionado.telefono}`);
    if(clienteSeleccionado.ciudad)   partes.push(clienteSeleccionado.ciudad);
  }
  document.getElementById('tCliente').textContent = partes.join(' · ');
  document.getElementById('tTipo').textContent = "Público";

  const tLineas = document.getElementById('tLineas'); 
  tLineas.innerHTML='';
  carrito.forEach(it=>{
    const fila = document.createElement('div'); 
    fila.className='t-row';

    // descripción recortada con elipsis
    const desc = document.createElement('span'); 
    desc.className='t-desc';
    desc.textContent = `${it.cantidad.toFixed(2)} ${it.nombre}`;

    // total importe (cantidad * precio)
    const imp = document.createElement('span'); 
    imp.className='t-imp'; 
    imp.textContent = money(it.importe);

    fila.appendChild(desc); 
    fila.appendChild(imp); 
    tLineas.appendChild(fila);
  });

  const { subtotal, iva, total } = calcularTotalesIncluyendoIVA();
  document.getElementById('tSubtotal').textContent = money(subtotal);
document.getElementById('tImpuestos').textContent = money(impuestos);
  document.getElementById('tTotal').textContent = money(total);

  document.getElementById('tMetodo').textContent = metodo.toUpperCase();
  const rRow = document.getElementById('tRecibidoRow');
  if(metodo==='efectivo' || metodo==='mixto'){
    rRow.style.display='block';
    document.getElementById('tRecibido').textContent = money(recibido);
    document.getElementById('tCambio').textContent = money(cambio);
  }else{
    rRow.style.display='none';
  }

  const notasExtra = [];
  if(clienteSeleccionado){
    notasExtra.push(`Factura: ${clienteSeleccionado.ocupa_factura ? 'Sí' : 'No'}`);
    if(clienteSeleccionado.ocupa_factura && clienteSeleccionado.rfc){
      notasExtra.push(`RFC: ${clienteSeleccionado.rfc}`);
    }
  }
  if(notas && notas.trim()) notasExtra.push(`Notas: ${notas.trim()}`);
  document.getElementById('tNotas').textContent = notasExtra.join(' · ');
}
    async function confirmarCobro(){
      try{
        const { subtotal, iva, total } = calcularTotalesIncluyendoIVA();
        const clienteTxt = elCliente.value || 'Mostrador';
        const metodo = metodoPago.value;

        // Validación de efectivo / mixto
        if(metodo==='efectivo' || metodo==='mixto'){
          const recibido = parseFloat(montoRecibido.value||'0');
          if(recibido < total){ alert('El pago recibido es menor que el total.'); return; }
        }

        const recibido = parseFloat(montoRecibido.value||'0');
        const cambio = Math.max(0, recibido - total);
        const notas = (notasCobro.value||'').trim();

        const folio = await getNextFolio(db);
        const fecha = new Date(); const fechaTxt = fecha.toLocaleString();

        const venta = {
          folio, rutaId,
          fecha: serverTimestamp(), fecha_txt: fechaTxt,
          cliente: clienteTxt,
          cliente_info: clienteSeleccionado ? {
            id: clienteSeleccionado.id,
            ocupa_factura: !!clienteSeleccionado.ocupa_factura,
            rfc: clienteSeleccionado.rfc || '',
            telefono: clienteSeleccionado.telefono || '',
            ciudad: clienteSeleccionado.ciudad || '',
            estado: clienteSeleccionado.estado || '',
            cp: clienteSeleccionado.cp || '',
            direccion: clienteSeleccionado.direccion || ''
          } : null,
          atendio: ATENDIO,
          tipo_precio: "publico",
          metodo_pago: metodo,
          recibido: (metodo==='efectivo'||metodo==='mixto') ? recibido : 0,
          cambio:   (metodo==='efectivo'||metodo==='mixto') ? cambio   : 0,
          subtotal, iva, total,
          notas,
          detalle: carrito.map(it=>({
            id: it.id, nombre: it.nombre, cantidad: it.cantidad,
            precio_unit: it.precioUnit, importe: it.importe,
            iva_tasa: Number(it.ivaTasa||0), precio_publico: it.precioPublico
          }))
        };

        const docId = await guardarVentaEnFirestore(venta);

        rellenarTicket({folio, fechaTxt, clienteTxt, metodo, recibido, cambio, notas});
        window.print();

        carrito = []; render(); cerrarCobro();

        const ventas = JSON.parse(localStorage.getItem('pos_ruta_ventas')||'[]');
        ventas.push({docId, ...venta, fecha_txt: fechaTxt});
        localStorage.setItem('pos_ruta_ventas', JSON.stringify(ventas));
      }catch(err){
        console.error(err);
        alert('No se pudo guardar la venta en Firebase. Revisa conexión y vuelve a intentar.');
      }
    }

    /***** Corte del día *****/
    async function corteDelDia(){
      try{
        const start = new Date(); start.setHours(0,0,0,0);
        const end   = new Date(); end.setHours(23,59,59,999);
        const tsStart = Timestamp.fromDate(start);
        const tsEnd   = Timestamp.fromDate(end);

        const ventasRef = collection(db, 'rutas_venta', rutaId, 'ventas');
        const q = query(ventasRef, where('fecha','>=', tsStart), where('fecha','<', tsEnd), orderBy('fecha','asc'));
        const snap = await getDocs(q);
        if(snap.empty){ alert('No hay ventas registradas hoy.'); return; }

        let total = 0, conteo = 0;
        const desg = { efectivo:0, tarjeta:0, transferencia:0, mixto:0 };
        snap.forEach(s=>{
          const v = s.data(); const t = Number(v.total||0);
          total += t; conteo += 1;
          const m = (v.metodo_pago||'').toLowerCase();
          if(m==='efectivo') desg.efectivo += t;
          else if(m==='tarjeta') desg.tarjeta += t;
          else if(m==='transferencia') desg.transferencia += t;
          else if(m==='mixto') desg.mixto += t;
        });

        const folioCorte = 'C-' + new Date().toISOString().replaceAll(/[-:T.Z]/g,'').slice(0,14);
        const fechaTxt = new Date().toLocaleString();

        document.getElementById('tFolio').textContent = `CORTE: ${folioCorte}`;
        document.getElementById('tFecha').textContent = fechaTxt;
        document.getElementById('tAtendio').textContent = ATENDIO;
        document.getElementById('tCliente').textContent = `Ruta: ${rutaId}`;
        document.getElementById('tTipo').textContent = 'Corte del día';

        const tLineas = document.getElementById('tLineas'); tLineas.innerHTML='';
        const mk = (l,r)=>{ const d=document.createElement('div'); d.className='t-row';
          const a=document.createElement('span'); a.className='t-desc'; a.textContent=l;
          const b=document.createElement('span'); b.className='t-imp'; b.textContent=money(r);
          d.appendChild(a); d.appendChild(b); return d; };
        tLineas.appendChild(mk('EFECTIVO',desg.efectivo));
        tLineas.appendChild(mk('TARJETA',desg.tarjeta));
        tLineas.appendChild(mk('TRANSFER',desg.transferencia));
        tLineas.appendChild(mk('MIXTO',desg.mixto));

        document.getElementById('tSubtotal').textContent = money(total);
        document.getElementById('tIva').textContent = money(0);
        document.getElementById('tTotal').textContent = money(total);
        document.getElementById('tMetodo').textContent = '—';
        document.getElementById('tRecibidoRow').style.display='none';
        document.getElementById('tNotas').textContent = 'Fin de día';

        window.print();
      }catch(err){
        console.error(err);
        alert('No se pudo generar el corte. Revisa la conexión.');
      }
    }

    // Botones
    document.getElementById('btnCobrar').onclick = abrirCobro;
    document.getElementById('btnCancelarCobro').onclick = cerrarCobro;
    document.getElementById('btnConfirmarCobro').onclick = confirmarCobro;
    document.getElementById('btnCorte').onclick = corteDelDia;

   await cargarCatalogoDesdeFirestore();
    render();
  </script>
</body>
</html>
